<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <title>ä¸‰å¹´ç´šæ•¸å­¸å†’éšªå­¸ç¿’æ©Ÿ</title>
  <style>
    :root {
      --bg: radial-gradient(circle at 20% 20%, #ffe8b3 0, #ffd6e8 26%, #d5e8ff 52%, #ccfbf1 100%);
      --card: #ffffffdd;
      --accent: #ff7a59;
      --accent-2: #3b82f6;
      --accent-3: #16a34a;
      --shadow: 0 20px 50px rgba(0, 0, 0, 0.08);
      --ip-1: #ffb703;
      --ip-2: #fb7185;
      --ip-3: #22c55e;
      --text: #14213d;
      --muted: #4b5563;
      font-family: 'Noto Sans TC', 'Segoe UI', system-ui, -apple-system, sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      min-height: 100vh;
      background: var(--bg);
      color: var(--text);
      position: relative;
      overflow-x: hidden;
    }

    .floating {
      position: absolute;
      inset: 0;
      pointer-events: none;
      overflow: hidden;
      z-index: 1;
    }

    .bubble {
      position: absolute;
      width: 180px;
      height: 180px;
      border-radius: 50%;
      filter: blur(36px);
      opacity: 0.45;
      animation: drift 18s ease-in-out infinite alternate;
    }

    .bubble.b1 { background: #ffb703aa; top: -40px; left: 6%; }
    .bubble.b2 { background: #34d399aa; top: 20%; right: -60px; animation-duration: 16s; }
    .bubble.b3 { background: #93c5fdaa; bottom: -60px; left: 20%; animation-duration: 20s; }
    .bubble.b4 { background: #fb7185aa; bottom: 10%; right: 12%; animation-duration: 22s; }

    @keyframes drift {
      from { transform: translateY(0) scale(1); }
      to { transform: translateY(-40px) scale(1.08); }
    }

    .sparkle {
      position: absolute;
      width: 10px;
      height: 10px;
      background: radial-gradient(circle, #fff 0%, transparent 60%);
      animation: twinkle 2s ease-in-out infinite alternate;
      opacity: 0.9;
    }

    .sparkle.s1 { top: 14%; left: 18%; animation-delay: 0.1s; }
    .sparkle.s2 { top: 34%; right: 25%; animation-delay: 0.5s; }
    .sparkle.s3 { bottom: 22%; left: 30%; animation-delay: 0.9s; }
    .sparkle.s4 { bottom: 30%; right: 18%; animation-delay: 1.3s; }

    @keyframes twinkle {
      from { transform: scale(0.8); opacity: 0.5; }
      to { transform: scale(1.4); opacity: 1; }
    }

    header {
      padding: 32px 24px 12px;
      display: flex;
      gap: 16px;
      align-items: center;
      flex-wrap: wrap;
      position: relative;
      z-index: 2;
    }

    .hero {
      flex: 1;
      background: linear-gradient(120deg, #fff7d6 0%, #ffe5f3 35%, #dff2ff 70%, #e4fffa 100%);
      border-radius: 24px;
      padding: 20px;
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 12px;
      box-shadow: var(--shadow);
      align-items: center;
    }

    .hero h1 {
      margin: 0 0 8px;
      font-size: 28px;
      letter-spacing: 0.4px;
    }

    .hero p {
      margin: 6px 0;
      color: var(--muted);
      line-height: 1.6;
    }

    .ip-card {
      background: #fff;
      border-radius: 18px;
      padding: 14px;
      box-shadow: inset 0 0 0 2px rgba(255, 255, 255, 0.6), var(--shadow);
      position: relative;
      overflow: hidden;
    }

    .ip-chip {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      font-weight: 700;
      color: #0f172a;
    }

    .ip-chip span {
      font-size: 13px;
      color: var(--muted);
    }

    .container {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 16px;
      padding: 0 24px 24px;
      position: relative;
      z-index: 2;
    }

    .panel {
      background: var(--card);
      border-radius: 22px;
      box-shadow: var(--shadow);
      padding: 18px;
      backdrop-filter: blur(6px);
    }

    .grid {
      display: grid;
      gap: 12px;
    }

    .two-col {
      grid-template-columns: repeat(2, minmax(0, 1fr));
    }

    .label {
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 4px;
    }

    .big-number {
      font-size: 30px;
      font-weight: 800;
      color: #0f172a;
    }

    .score-row {
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      background: #fff;
      padding: 8px 12px;
      border-radius: 12px;
      font-weight: 700;
      color: #0f172a;
      box-shadow: inset 0 0 0 1px rgba(0, 0, 0, 0.04);
    }

    .level-cards {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 12px;
      margin-top: 12px;
    }

    .card {
      padding: 12px;
      background: #fff;
      border-radius: 16px;
      border: 2px solid transparent;
      cursor: pointer;
      transition: all 0.2s ease;
      position: relative;
      overflow: hidden;
      isolation: isolate;
    }

    .card:hover {
      transform: translateY(-2px);
      box-shadow: var(--shadow);
    }

    .card.active {
      border-color: var(--accent);
      box-shadow: 0 10px 30px rgba(255, 122, 89, 0.2);
    }

    .card::after {
      content: '';
      position: absolute;
      inset: 0;
      background: radial-gradient(circle at 20% 20%, rgba(255,255,255,0.8), transparent 50%);
      opacity: 0;
      transition: opacity 0.2s ease;
      z-index: -1;
    }

    .card:hover::after {
      opacity: 1;
    }

    .card.locked {
      cursor: not-allowed;
      opacity: 0.6;
    }

    .card h3 {
      margin: 0;
    }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: #f3f4f6;
      color: #111827;
      font-size: 12px;
      font-weight: 700;
    }

    .question-card {
      padding: 18px;
      border-radius: 18px;
      background: linear-gradient(135deg, #fff, #fff7ed);
      border: 1px solid #ffe0b3;
      box-shadow: var(--shadow);
      position: relative;
      overflow: hidden;
      isolation: isolate;
    }

    .question-title {
      margin: 0 0 6px;
      font-size: 20px;
      font-weight: 800;
    }

    .question-text {
      margin: 8px 0 12px;
      font-size: 18px;
      line-height: 1.6;
      color: #0f172a;
    }

    .actions {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    input[type="number"] {
      width: 180px;
      padding: 12px 14px;
      border-radius: 14px;
      border: 1px solid #cbd5e1;
      font-size: 16px;
    }

    button {
      padding: 12px 16px;
      border-radius: 14px;
      border: none;
      font-weight: 800;
      cursor: pointer;
      transition: transform 0.15s ease, box-shadow 0.15s ease;
      font-size: 15px;
    }

    button.primary {
      background: linear-gradient(120deg, #ff7a59, #ffb703);
      color: #0b1524;
      box-shadow: 0 10px 25px rgba(255, 122, 89, 0.3);
    }

    button.secondary {
      background: #0ea5e9;
      color: #0b1524;
      box-shadow: 0 10px 25px rgba(14, 165, 233, 0.25);
    }

    button.ghost {
      background: #fff;
      color: #0f172a;
      border: 1px solid #e2e8f0;
    }

    button:active {
      transform: translateY(1px);
    }

    .feedback {
      margin-top: 10px;
      padding: 12px;
      border-radius: 14px;
      background: #f8fafc;
      border: 1px dashed #cbd5e1;
      color: #0f172a;
      min-height: 44px;
    }

    .progress {
      height: 10px;
      background: #e5e7eb;
      border-radius: 999px;
      overflow: hidden;
      margin: 8px 0 6px;
    }

    .progress span {
      display: block;
      height: 100%;
      background: linear-gradient(120deg, #22c55e, #a3e635);
      transition: width 0.25s ease;
    }

    .log {
      padding: 0;
      list-style: none;
      margin: 8px 0 0;
      max-height: 220px;
      overflow-y: auto;
    }

    .log li {
      padding: 8px 10px;
      margin-bottom: 6px;
      border-radius: 10px;
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      font-size: 14px;
    }

    .sound-toggle {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 8px 12px;
      background: #fff;
      border-radius: 12px;
      border: 1px solid #e2e8f0;
      cursor: pointer;
      font-weight: 700;
    }

    .mini-map {
      display: grid;
      gap: 10px;
    }

    .mini-step {
      display: grid;
      grid-template-columns: 24px 1fr 60px;
      gap: 8px;
      align-items: center;
      padding: 10px;
      border-radius: 12px;
      background: #f1f5f9;
    }

    .mini-step.active {
      background: #dbeafe;
      border: 1px solid #bfdbfe;
    }

    .chip-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .hint {
      font-size: 13px;
      color: var(--muted);
    }

    .mascot {
      position: absolute;
      right: 16px;
      top: 12px;
      width: 120px;
      height: 120px;
      border-radius: 30px;
      background: radial-gradient(circle at 30% 30%, #fff 0%, #ffe6f2 50%, #ffd1c2 100%);
      box-shadow: 0 15px 40px rgba(255, 122, 89, 0.32);
      display: grid;
      place-items: center;
      transform: rotate(6deg);
      animation: floaty 4s ease-in-out infinite;
    }

    .mascot span {
      font-size: 46px;
    }

    @keyframes floaty {
      0% { transform: translateY(0) rotate(6deg); }
      50% { transform: translateY(-8px) rotate(4deg); }
      100% { transform: translateY(0) rotate(6deg); }
    }

    .ticker {
      display: grid;
      grid-template-columns: auto 1fr;
      gap: 8px;
      align-items: center;
      margin: 10px 0 0;
      padding: 10px 12px;
      border-radius: 14px;
      background: linear-gradient(90deg, rgba(255, 183, 3, 0.14), rgba(14, 165, 233, 0.16));
      border: 1px solid rgba(0,0,0,0.04);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.7);
    }

    .ticker .dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      background: #f97316;
      animation: blink 1.4s infinite;
    }

    @keyframes blink {
      0%, 100% { opacity: 0.7; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.2); }
    }

    .sticker-bar {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 8px;
    }

    .sticker {
      padding: 8px 12px;
      border-radius: 12px;
      background: #0f172a;
      color: #fff;
      font-weight: 800;
      letter-spacing: 0.2px;
      box-shadow: 0 8px 20px rgba(15,23,42,0.2);
    }

    .orbit-row {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 6px;
    }

    .orbit {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: linear-gradient(135deg, #fff 0%, var(--accent) 100%);
      box-shadow: 0 6px 16px rgba(255, 122, 89, 0.3);
      animation: orbit 2.6s ease-in-out infinite alternate;
    }

    @keyframes orbit {
      from { transform: translateY(0) rotate(-6deg); }
      to { transform: translateY(-6px) rotate(6deg); }
    }

    .buddy-card {
      background: linear-gradient(120deg, #0ea5e915, #a855f715, #f9731615);
      border: 1px solid rgba(255,255,255,0.6);
      border-radius: 14px;
      padding: 12px;
      box-shadow: var(--shadow);
      display: flex;
      gap: 12px;
      align-items: center;
    }

    .buddy-emoji {
      width: 52px;
      height: 52px;
      border-radius: 14px;
      display: grid;
      place-items: center;
      font-size: 28px;
      background: #fff;
      box-shadow: inset 0 0 0 1px #e5e7eb, 0 8px 24px rgba(0,0,0,0.08);
    }

    .pill.soft {
      background: rgba(255,255,255,0.8);
      border: 1px solid rgba(0,0,0,0.04);
      box-shadow: 0 10px 24px rgba(0,0,0,0.06);
    }
  </style>
  <script type="module">
    const levelConfigs = [
      {
        id: 'forest',
        title: 'éœ“å½©æœæ—ãƒ»åŠ æ¸›å°å‹‡è€…',
        ip: 'å’”å•¦é¾ & æœå‡ç‹',
        max: 25,
        ops: ['+', '-'],
        target: 6,
        color: '#ffb703',
        vibe: 'ç”œç”œæ°´æœæ£®æ—ï¼Œå’”å•¦é¾å¹«ä½ æ¡æœå¯¦åšè¨ˆç®—è—¥æ°´ï¼'
      },
      {
        id: 'reef',
        title: 'æµ·å…‰çŠç‘šåŸãƒ»ä¹˜æ³•æ½›è‰‡',
        ip: 'æ³¡æ³¡è™é¯¨ & é–ƒäº®é­Ÿ',
        max: 60,
        ops: ['+', '-', 'Ã—'],
        target: 7,
        color: '#0ea5e9',
        vibe: 'åœ¨æµ·åº•åŸå¸‚è’é›†çç ï¼Œä¹˜æ³•æ˜¯ä½ çš„æ¸¦è¼ªå¼•æ“ï¼'
      },
      {
        id: 'star',
        title: 'æ˜Ÿéš›è£œçµ¦ç«™ãƒ»ç™¾æ•¸å†’éšª',
        ip: 'å®‡å®™å–µè‰¦é•·',
        max: 120,
        ops: ['+', '-', 'Ã—'],
        target: 8,
        color: '#a855f7',
        vibe: 'ç©¿è¶Šè¡Œæ˜Ÿç’°æ”¶é›†èƒ½é‡æ™¶ç‰‡ï¼Œç”¨å¿ƒç®—ä¿è­·å¤ªç©ºèˆ¹ï¼'
      }
    ];

    const tickerTexts = [
      'ä»Šå¤©çš„ä»»å‹™ï¼šå¹«å’”å•¦é¾è’é›†èƒ½é‡æœå¯¦ï¼',
      'ä¿æŒç¯€å¥ï¼šé€£çºŒç­”å°è¶Šå¤šï¼Œåˆ†æ•¸è¡æ›´å¿«ï¼',
      'æ³¡æ³¡è™é¯¨èªªï¼šæ›é¡Œä¹Ÿæ²’é—œä¿‚ï¼Œè¨˜å¾—æ·±å‘¼å¸ï½',
      'å®‡å®™å–µè‰¦é•·éœ€è¦è£œçµ¦ï¼Œå¿«ç”¨ä¹˜æ³•ç®—å‡ºèƒ½é‡ï¼',
      'æœå‡ç‹å–œæ­¡ç•«åœ–ç®—æ•¸ï¼Œè©¦è©¦è‰ç¨¿æ€è€ƒæ³•ã€‚',
      'æç¤ºï¼šä¹˜æ³•å¯ä»¥ç”¨è·³è·³æ•¸ï¼Œ+3ã€+3ã€+3 çš„ç¯€å¥ã€‚',
      'å’”å•¦é¾ï¼šä¿æŒéŸ³æ•ˆé–‹å•Ÿï¼Œç­”å°å°±æœƒè·³èˆï¼'
    ];

    const buddyShouts = [
      'ã€Œå‡ºç™¼ï¼ç”¨æ•¸å­—é­”æ³•å®ˆè­·æœæ—ï¼ã€',
      'ã€Œé€£å‹é–ƒé›»åŠ æˆï¼Œè®“ç©åˆ†å’»å’»æ¼²ï¼ã€',
      'ã€Œæƒ³åƒè‡ªå·±æ˜¯ DJï¼ŒæŠŠç¯€å¥æ‰“æº–å°±æˆåŠŸï¼ã€',
      'ã€Œç­”éŒ¯æ²’é—œä¿‚ï¼Œæ›å€‹æ–¹æ³•å†è¡ï¼ã€',
      'ã€Œå°æ•¸å­¸å®¶ï¼Œä»Šå¤©ä¹Ÿè¦å‹‡æ•¢é—–é—œï¼ã€'
    ];

    const mascotEmojis = ['ğŸ¦Š', 'ğŸ‰', 'ğŸ¯', 'ğŸ¦„', 'ğŸ³', 'ğŸš€', 'ğŸŒ '];

    const logList = [];
    let currentLevel = levelConfigs[0];
    let currentQuestion = null;
    let score = 0;
    let streak = 0;
    let bestStreak = 0;
    let questionsAnswered = 0;
    let unlockedLevels = new Set([levelConfigs[0].id]);
    let soundOn = true;
    const STORAGE_KEY = 'mathQuestSave';
    let audioContext;

    function initAudio() {
      if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
      }
    }

    function playSound(type = 'correct') {
      if (!soundOn) return;
      initAudio();
      const osc = audioContext.createOscillator();
      const gain = audioContext.createGain();
      osc.connect(gain).connect(audioContext.destination);
      osc.type = 'sine';
      const now = audioContext.currentTime;
      if (type === 'correct') {
        osc.frequency.setValueAtTime(620, now);
        osc.frequency.exponentialRampToValueAtTime(880, now + 0.2);
      } else if (type === 'wrong') {
        osc.type = 'triangle';
        osc.frequency.setValueAtTime(200, now);
        osc.frequency.exponentialRampToValueAtTime(120, now + 0.25);
      } else {
        osc.frequency.setValueAtTime(480, now);
      }
      gain.gain.setValueAtTime(0.001, now);
      gain.gain.exponentialRampToValueAtTime(0.2, now + 0.05);
      gain.gain.exponentialRampToValueAtTime(0.0001, now + 0.35);
      osc.start(now);
      osc.stop(now + 0.4);
    }

    function saveProgress() {
      const payload = {
        levelId: currentLevel.id,
        score,
        streak,
        bestStreak,
        questionsAnswered,
        unlocked: [...unlockedLevels],
        log: logList.slice(-20)
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
      toast('é€²åº¦å·²è‡ªå‹•ä¿å­˜ï¼');
    }

    function loadProgress() {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return;
      try {
        const data = JSON.parse(raw);
        const level = levelConfigs.find(l => l.id === data.levelId) || levelConfigs[0];
        currentLevel = level;
        score = data.score || 0;
        streak = data.streak || 0;
        bestStreak = data.bestStreak || 0;
        questionsAnswered = data.questionsAnswered || 0;
        unlockedLevels = new Set(data.unlocked || [levelConfigs[0].id]);
        logList.push(...(data.log || []));
        renderLevelCards();
        updateStats();
        renderLog();
        updateHero();
        generateQuestion();
        toast('è¼‰å…¥ä¸Šæ¬¡é€²åº¦ï¼');
      } catch (e) {
        console.error('Load failed', e);
      }
    }

    function randomFrom(arr) {
      return arr[Math.floor(Math.random() * arr.length)];
    }

    function refreshTicker() {
      document.getElementById('tickerText').textContent = randomFrom(tickerTexts);
    }

    function refreshBuddy() {
      document.getElementById('buddyMessage').textContent = randomFrom(buddyShouts);
      document.getElementById('buddyEmoji').textContent = randomFrom(mascotEmojis);
    }

    function refreshMascot() {
      document.getElementById('mascotEmoji').textContent = randomFrom(mascotEmojis);
    }

    function createQuestion() {
      const max = currentLevel.max;
      const op = randomFrom(currentLevel.ops);
      const contexts = [
        'å’”å•¦é¾è¦ç…®è—¥æ°´ï¼Œæ”¶é›†',
        'æœå‡ç‹æ‹¼åœ–å°‘äº†',
        'æ³¡æ³¡è™é¯¨åœ¨èˆå°å™´å°„',
        'é–ƒäº®é­Ÿè¦é€ç¦®ç‰©ï¼Œæ‰‹ä¸Šæœ‰',
        'å®‡å®™å–µè‰¦é•·è£œçµ¦è‰™å‰©ä¸‹'
      ];
      const num1 = Math.floor(Math.random() * max / 2) + 6;
      const num2 = Math.floor(Math.random() * max / 2) + 3;
      let text = '';
      let answer = 0;

      if (op === '+') {
        text = `${randomFrom(contexts)} ${num1} å€‹ï¼Œè·¯ä¸Šåˆé‡åˆ° ${num2} å€‹ï¼Œç¾åœ¨å…±æœ‰å¹¾å€‹ï¼Ÿ`;
        answer = num1 + num2;
      } else if (op === '-') {
        const bigger = Math.max(num1 + 5, num2 + 5);
        const smaller = Math.min(num1, num2);
        text = `${randomFrom(contexts)} ${bigger} é¡†èƒ½é‡ç³–ï¼Œé€å‡º ${smaller} é¡†ï¼Œé‚„å‰©å¹¾é¡†ï¼Ÿ`;
        answer = bigger - smaller;
      } else {
        const safeNum1 = Math.min(12, Math.max(3, Math.round(num1 / 3)));
        const safeNum2 = Math.min(9, Math.max(2, Math.round(num2 / 4)));
        text = `${randomFrom(contexts)} æ¯æ¬¡å°„å‡º ${safeNum1} æœµå…‰èŠ±ï¼Œè¦å°„å‡º ${safeNum2} æ¬¡ï¼Œä¸€å…±å¹¾æœµï¼Ÿ`;
        answer = safeNum1 * safeNum2;
      }

      const hint = op === 'Ã—'
        ? 'ä¹˜æ³•å¯æƒ³æˆã€Œé‡è¤‡åŠ æ³•ã€ï¼Œä¹Ÿå¯ä»¥ç”¨è·³è·³æ•¸ï¼šæ¯æ¬¡åŠ ç›¸åŒçš„é‡ã€‚'
        : 'å…ˆæŠ“å‡ºé‡è¦æ•¸å­—ï¼Œç•«åœ–æˆ–ç”¨æ‰‹æŒ‡åˆ†æ®µè¨ˆç®—ï¼Œè®“è…¦è¢‹ä¿æŒç¯€å¥ã€‚';

      return { text, answer, hint, op };
    }

    function generateQuestion() {
      currentQuestion = createQuestion();
      document.getElementById('questionText').textContent = currentQuestion.text;
      document.getElementById('hint').textContent = currentQuestion.hint;
      document.getElementById('answerInput').value = '';
      document.getElementById('answerInput').focus();
      document.getElementById('feedback').textContent = '';
      document.getElementById('opTag').textContent = `ä»Šæ—¥ä»»å‹™ï¼š${translateOp(currentQuestion.op)}ç·´ç¿’`;
      document.getElementById('progressNow').style.width = `${(questionsAnswered / currentLevel.target) * 100}%`;
      refreshTicker();
      refreshBuddy();
      refreshMascot();
    }

    function translateOp(op) {
      return op === '+' ? 'åŠ æ³•' : op === '-' ? 'æ¸›æ³•' : 'ä¹˜æ³•';
    }

    function updateStats() {
      document.getElementById('score').textContent = score;
      document.getElementById('streak').textContent = streak;
      document.getElementById('bestStreak').textContent = bestStreak;
      document.getElementById('currentLevelName').textContent = currentLevel.title;
      document.getElementById('levelIp').textContent = currentLevel.ip;
      document.getElementById('levelVibe').textContent = currentLevel.vibe;
      document.documentElement.style.setProperty('--accent', currentLevel.color);
      document.getElementById('progressTarget').textContent = currentLevel.target;
      document.getElementById('progressNow').style.width = `${(questionsAnswered / currentLevel.target) * 100}%`;
      document.getElementById('opList').textContent = currentLevel.ops.map(o => translateOp(o)).join('ãƒ»');
    }

    function renderLevelCards() {
      const wrapper = document.getElementById('levelCards');
      wrapper.innerHTML = '';
      levelConfigs.forEach((lvl, index) => {
        const card = document.createElement('div');
        card.className = 'card';
        if (currentLevel.id === lvl.id) card.classList.add('active');
        const locked = !unlockedLevels.has(lvl.id);
        if (locked) card.classList.add('locked');
        card.innerHTML = `
          <div class="pill" style="background:${lvl.color}20;color:${lvl.color.replace('#', '#')};">
            LV${index + 1}
            ${locked ? 'ğŸ”’' : 'ğŸš€'}
          </div>
          <h3>${lvl.title}</h3>
          <div class="hint">${lvl.vibe}</div>
          <div class="chip-row">
            <span class="pill">é‹ç®—ï¼š${lvl.ops.map(o => translateOp(o)).join('ã€')}</span>
            <span class="pill">ç›®æ¨™ï¼š${lvl.target} é¡Œ</span>
          </div>
        `;
        card.addEventListener('click', () => {
          if (locked) {
            toast('å…ˆç ´å®Œä¸Šä¸€ç«™æ‰æœƒè§£é–å–”ï¼');
            return;
          }
          currentLevel = lvl;
          questionsAnswered = 0;
          streak = 0;
          updateStats();
          renderLevelCards();
          updateHero();
          generateQuestion();
          toast(`åˆ‡æ›åˆ° ${lvl.title}`);
        });
        wrapper.appendChild(card);
      });
    }

    function renderLog() {
      const list = document.getElementById('log');
      list.innerHTML = '';
      const recent = logList.slice(-20).reverse();
      recent.forEach(item => {
        const li = document.createElement('li');
        li.innerHTML = `<span>${item.icon} ${item.text}</span><strong>${item.delta > 0 ? '+' : ''}${item.delta}</strong>`;
        list.appendChild(li);
      });
    }

    function toast(text) {
      const el = document.getElementById('feedback');
      el.textContent = text;
    }

    function celebrate() {
      playSound('correct');
      streak += 1;
      bestStreak = Math.max(bestStreak, streak);
      score += 12 + streak * 2;
      questionsAnswered += 1;
      logList.push({ icon: 'ğŸŒŸ', text: 'é—–é—œæˆåŠŸï¼', delta: 10 + streak * 2 });
      updateStats();
      renderLog();
      if (questionsAnswered >= currentLevel.target) {
        toast('æ­å–œå®Œæˆæ­¤é—œï¼ä¸‹ä¸€ç«™è§£é–ï¼');
        const idx = levelConfigs.findIndex(l => l.id === currentLevel.id);
        const next = levelConfigs[idx + 1];
        if (next) unlockedLevels.add(next.id);
        questionsAnswered = 0;
        renderLevelCards();
        saveProgress();
      } else {
        saveProgress();
      }
    }

    function markWrong() {
      streak = 0;
      score = Math.max(0, score - 3);
      logList.push({ icon: 'ğŸ’¤', text: 'å†æƒ³æƒ³ï¼Œæ›å€‹æ–¹æ³•ï¼', delta: -3 });
      renderLog();
      saveProgress();
    }

    function checkAnswer() {
      const input = document.getElementById('answerInput');
      const userAnswer = parseInt(input.value, 10);
      if (Number.isNaN(userAnswer)) {
        toast('å…ˆè¼¸å…¥ä½ çš„ç­”æ¡ˆå–”ï¼');
        playSound('neutral');
        return;
      }
      if (userAnswer === currentQuestion.answer) {
        toast('ç­”å°äº†ï¼è§’è‰²è·³èˆæ…¶ç¥ ğŸ‰');
        celebrate();
        generateQuestion();
      } else {
        toast(`ç­”éŒ¯äº†ï¼Œè©¦è©¦çœ‹ï¼š${currentQuestion.hint}`);
        playSound('wrong');
        markWrong();
      }
    }

    function skipQuestion() {
      toast('æ›ä¸€é¡Œï¼ä¿æŒç¯€å¥ï½');
      streak = 0;
      generateQuestion();
    }

    function updateHero() {
      const chip = document.getElementById('ipChip');
      chip.textContent = `${currentLevel.ip} Â· ${currentLevel.title}`;
      chip.style.background = currentLevel.color + '30';
    }

    function attachEvents() {
      document.getElementById('submitAnswer').addEventListener('click', checkAnswer);
      document.getElementById('skip').addEventListener('click', skipQuestion);
      document.getElementById('save').addEventListener('click', saveProgress);
      document.getElementById('reload').addEventListener('click', () => {
        loadProgress();
      });
      document.getElementById('soundToggle').addEventListener('click', () => {
        soundOn = !soundOn;
        document.getElementById('soundToggle').textContent = soundOn ? 'ğŸ”Š éŸ³æ•ˆé–‹å•Ÿ' : 'ğŸ”‡ éŸ³æ•ˆé—œé–‰';
      });
      document.getElementById('answerInput').addEventListener('keyup', (e) => {
        if (e.key === 'Enter') checkAnswer();
      });
    }

    window.addEventListener('DOMContentLoaded', () => {
      renderLevelCards();
      attachEvents();
      updateStats();
      updateHero();
      generateQuestion();
      refreshTicker();
      refreshBuddy();
      refreshMascot();
      setInterval(refreshTicker, 9000);
      loadProgress();
    });
  </script>
</head>
<body>
  <div class="floating">
    <div class="bubble b1"></div>
    <div class="bubble b2"></div>
    <div class="bubble b3"></div>
    <div class="bubble b4"></div>
    <div class="sparkle s1"></div>
    <div class="sparkle s2"></div>
    <div class="sparkle s3"></div>
    <div class="sparkle s4"></div>
  </div>
  <header>
    <div class="hero">
      <div>
        <div class="ip-chip" id="ipChip" style="background:#ffedd5;">å’”å•¦é¾ & æœå‡ç‹ Â· éœ“å½©æœæ—</div>
        <h1>ä¸‰å¹´ç´šæ•¸å­¸å†’éšªå­¸ç¿’æ©Ÿ</h1>
        <p id="levelVibe">ç”œç”œæ°´æœæ£®æ—ï¼Œå’”å•¦é¾å¹«ä½ æ¡æœå¯¦åšè¨ˆç®—è—¥æ°´ï¼</p>
        <div class="chip-row">
          <div class="badge">ğŸ® éŠæˆ²å¼é—–é—œ</div>
          <div class="badge">ğŸµ æµè¡ŒéŸ³æ•ˆ</div>
          <div class="badge">ğŸ›°ï¸ é€²åº¦å¯ä¿å­˜</div>
        </div>
        <div class="sticker-bar">
          <div class="sticker">ğŸŒˆ Math DJ</div>
          <div class="sticker">ğŸ‰ å†’éšªå®¶</div>
          <div class="sticker">âš¡ é€£å‹ä¸­</div>
        </div>
        <div class="ticker">
          <div class="dot"></div>
          <div id="tickerText">ä»Šå¤©çš„ä»»å‹™ï¼šå¹«å’”å•¦é¾è’é›†èƒ½é‡æœå¯¦ï¼</div>
        </div>
        <div class="orbit-row">
          <div class="orbit"></div>
          <div class="orbit" style="animation-delay:0.2s;background:linear-gradient(135deg,#fff 0%,#0ea5e9 100%);"></div>
          <div class="orbit" style="animation-delay:0.4s;background:linear-gradient(135deg,#fff 0%,#22c55e 100%);"></div>
        </div>
      </div>
      <div class="ip-card">
        <div class="label">ä»Šæ—¥ä¸»è§’</div>
        <div class="big-number" id="currentLevelName">éœ“å½©æœæ—ãƒ»åŠ æ¸›å°å‹‡è€…</div>
        <div class="hint">IP å¤¥ä¼´ï¼š<span id="levelIp">å’”å•¦é¾ & æœå‡ç‹</span></div>
        <div class="chip-row" style="margin-top:8px;">
          <div class="pill" id="opList">åŠ æ³•ãƒ»æ¸›æ³•</div>
        </div>
        <div class="chip-row" style="margin-top:8px;">
          <button class="ghost" id="save">ğŸ’¾ ä¿å­˜é€²åº¦</button>
          <button class="ghost" id="reload">â±ï¸ è¼‰å…¥ä¸Šæ¬¡</button>
          <div class="sound-toggle" id="soundToggle">ğŸ”Š éŸ³æ•ˆé–‹å•Ÿ</div>
        </div>
        <div class="buddy-card" style="margin-top:10px;">
          <div class="buddy-emoji" id="buddyEmoji">ğŸ‰</div>
          <div>
            <div class="label">å†’éšªå¤¥ä¼´å£è™Ÿ</div>
            <div class="big-number" style="font-size:18px;" id="buddyMessage">ã€Œå‡ºç™¼ï¼ç”¨æ•¸å­—é­”æ³•å®ˆè­·æœæ—ï¼ã€</div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <div class="container">
    <section class="panel">
      <div class="grid two-col">
        <div class="panel" style="box-shadow:none;background:#fff;">
          <div class="label">ä»»å‹™é€²åº¦</div>
          <div class="score-row">
            <div>
              <div class="big-number" id="score">0</div>
              <div class="label">å†’éšªç©åˆ†</div>
            </div>
            <div>
              <div class="big-number" id="streak">0</div>
              <div class="label">é€£çºŒç­”å°</div>
            </div>
            <div>
              <div class="big-number" id="bestStreak">0</div>
              <div class="label">æœ€ä½³ç´€éŒ„</div>
            </div>
          </div>
          <div class="progress">
            <span id="progressNow" style="width:0%;"></span>
          </div>
          <div class="hint">å®Œæˆ <span id="progressTarget">6</span> é¡Œæœƒè‡ªå‹•è§£é–ä¸‹ä¸€ç«™ï¼</div>
        </div>
        <div class="panel" style="box-shadow:none;background:#fff;">
          <div class="label">é¸æ“‡é—œå¡</div>
          <div class="level-cards" id="levelCards"></div>
        </div>
      </div>

      <div class="question-card">
        <div class="pill" id="opTag">ä»Šæ—¥ä»»å‹™ï¼šåŠ æ³•ç·´ç¿’</div>
        <h2 class="question-title">å’”å•¦é¾çš„æ²‰æµ¸å¼æŒ‘æˆ°</h2>
        <p class="question-text" id="questionText">æº–å‚™å¥½äº†å—ï¼Ÿè®“æˆ‘å€‘é–‹å§‹ï¼</p>
        <div class="hint" id="hint">ç”¨æ•…äº‹æƒ…å¢ƒå¸¶ä½ ç®—å‡ºç­”æ¡ˆã€‚</div>
        <div class="actions" style="margin:10px 0;">
          <input type="number" id="answerInput" placeholder="è¼¸å…¥ç­”æ¡ˆ..." />
          <button class="primary" id="submitAnswer">âœ¨ ç¢ºèªç­”æ¡ˆ</button>
          <button class="secondary" id="skip">ğŸ”„ å†æ›ä¸€é¡Œ</button>
        </div>
        <div class="feedback" id="feedback"></div>
        <div class="mascot"><span id="mascotEmoji">ğŸ¦Š</span></div>
      </div>
    </section>

    <section class="panel">
      <div class="label">å†’éšªç­†è¨˜</div>
      <div class="mini-map">
        <div class="mini-step active">
          <div>1ï¸âƒ£</div>
          <div>
            <strong>æš–èº«æŒ‘æˆ°</strong>
            <div class="hint">åŠ æ¸›æ³•æ•…äº‹é¡Œï¼Œè®“è…¦è¢‹ç†±èµ·ä¾†ã€‚</div>
          </div>
          <span class="pill">å®Œæˆ 3 é¡Œ</span>
        </div>
        <div class="mini-step">
          <div>2ï¸âƒ£</div>
          <div>
            <strong>ç¯€å¥çªç ´</strong>
            <div class="hint">ä¹˜æ³•æ›ç®—ï¼ŒæŠŠåŒæ¨£çš„æ•¸å­—åŠ èµ·ä¾†ã€‚</div>
          </div>
          <span class="pill">å®Œæˆ 5 é¡Œ</span>
        </div>
        <div class="mini-step">
          <div>3ï¸âƒ£</div>
          <div>
            <strong>æ˜Ÿå…‰æ”¶å°¾</strong>
            <div class="hint">ä¿æŒé€£å‹ï¼Œæ‹šæ›´é«˜åˆ†æ•¸ï¼</div>
          </div>
          <span class="pill">è¡åˆºæ¨¡å¼</span>
        </div>
      </div>
      <div class="label" style="margin-top:10px;">æœ€è¿‘äº‹ä»¶</div>
      <ul class="log" id="log"></ul>
      <div class="hint" style="margin-top:8px;">æç¤ºï¼šç©åˆ†æœƒè‡ªå‹•ä¿å­˜ï¼Œæƒ³æ›é—œå¡éš¨æ™‚åˆ‡æ›ã€‚</div>
    </section>
  </div>
</body>
</html>
