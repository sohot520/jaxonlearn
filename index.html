<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>JaxonLearn - æ•¸å­¸å†’éšªç‹åœ‹</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700;900&display=swap" rel="stylesheet">
  <style>
    :root {
      --primary: #6C5CE7;
      --secondary: #00CEC9;
      --accent: #FDCB6E;
      --danger: #E17055;
      --success: #00B894;
      --dark: #2D3436;
      --light: #DFE6E9;
      --white: #FFFFFF;
      --gradient-1: linear-gradient(135deg, #6C5CE7 0%, #A29BFE 100%);
      --gradient-2: linear-gradient(135deg, #00CEC9 0%, #81ECEC 100%);
      --gradient-3: linear-gradient(135deg, #FDCB6E 0%, #F39C12 100%);
      --shadow: 0 10px 40px rgba(0,0,0,0.2);
      --shadow-sm: 0 4px 15px rgba(0,0,0,0.1);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Noto Sans TC', sans-serif;
      background: linear-gradient(180deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      min-height: 100vh;
      color: var(--white);
      overflow-x: hidden;
    }

    /* ===== é€šç”¨å…ƒä»¶ ===== */
    .screen {
      display: none;
      width: 100%;
      min-height: 100vh;
      padding: 20px;
      padding-bottom: 100px;
      animation: fadeIn 0.3s ease;
    }

    .screen.active {
      display: block;
    }

    /* ç„¡åº•éƒ¨å°èˆªçš„ç•«é¢ */
    .screen.no-nav {
      padding-bottom: 20px;
    }

    .screen.no-nav.active {
      display: flex;
      flex-direction: column;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .btn {
      padding: 15px 30px;
      border: none;
      border-radius: 50px;
      font-size: 18px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .btn-primary {
      background: var(--gradient-1);
      color: var(--white);
      box-shadow: 0 5px 20px rgba(108, 92, 231, 0.4);
    }

    .btn-primary:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 30px rgba(108, 92, 231, 0.6);
    }

    .btn-secondary {
      background: var(--gradient-2);
      color: var(--dark);
      box-shadow: 0 5px 20px rgba(0, 206, 201, 0.4);
    }

    .btn-accent {
      background: var(--gradient-3);
      color: var(--dark);
      box-shadow: 0 5px 20px rgba(253, 203, 110, 0.4);
    }

    .btn-sm {
      padding: 10px 20px;
      font-size: 14px;
    }

    .card {
      background: rgba(255,255,255,0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 20px;
      border: 1px solid rgba(255,255,255,0.1);
    }

    /* ===== é ‚éƒ¨å°èˆª ===== */
    .top-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background: rgba(0,0,0,0.3);
      border-radius: 15px;
      margin-bottom: 20px;
    }

    .currency-display {
      display: flex;
      gap: 15px;
    }

    .currency-item {
      display: flex;
      align-items: center;
      gap: 5px;
      background: rgba(255,255,255,0.1);
      padding: 8px 15px;
      border-radius: 20px;
      font-weight: 700;
    }

    .currency-icon {
      font-size: 20px;
    }

    .player-info {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .player-level {
      background: var(--gradient-3);
      color: var(--dark);
      padding: 5px 12px;
      border-radius: 15px;
      font-weight: 900;
      font-size: 14px;
    }

    .player-name {
      font-weight: 700;
    }

    .exp-bar-mini {
      width: 80px;
      height: 8px;
      background: rgba(255,255,255,0.2);
      border-radius: 10px;
      overflow: hidden;
    }

    .exp-bar-mini-fill {
      height: 100%;
      background: var(--gradient-3);
      transition: width 0.5s ease;
    }

    /* ===== ç™»å…¥/é¸æ“‡ç•«é¢ ===== */
    #login-screen {
      align-items: center;
      justify-content: center;
      text-align: center;
    }

    #create-avatar-screen {
      justify-content: flex-start;
      padding-top: 40px;
    }

    #game-screen {
      justify-content: center;
      align-items: center;
    }

    #parent-screen {
      padding-bottom: 40px;
    }

    .logo {
      font-size: 48px;
      font-weight: 900;
      margin-bottom: 10px;
      background: linear-gradient(135deg, #FDCB6E 0%, #E17055 50%, #6C5CE7 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      text-shadow: 0 0 60px rgba(108, 92, 231, 0.5);
    }

    .logo-subtitle {
      font-size: 18px;
      color: var(--light);
      margin-bottom: 50px;
    }

    .login-buttons {
      display: flex;
      flex-direction: column;
      gap: 20px;
      width: 100%;
      max-width: 300px;
    }

    .login-btn {
      padding: 25px;
      border-radius: 20px;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 15px;
    }

    .login-btn .icon {
      font-size: 40px;
    }

    /* ===== è§’è‰²å‰µå»ºç•«é¢ ===== */
    #create-avatar-screen {
      text-align: center;
    }

    .avatar-selection {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      max-width: 500px;
      margin: 30px auto;
    }

    .avatar-option {
      background: rgba(255,255,255,0.1);
      border-radius: 20px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 3px solid transparent;
    }

    .avatar-option:hover {
      transform: scale(1.05);
      background: rgba(255,255,255,0.2);
    }

    .avatar-option.selected {
      border-color: var(--accent);
      background: rgba(253, 203, 110, 0.2);
    }

    .avatar-preview {
      font-size: 60px;
      margin-bottom: 10px;
    }

    .avatar-name-input {
      padding: 15px 25px;
      font-size: 20px;
      border: none;
      border-radius: 50px;
      background: rgba(255,255,255,0.1);
      color: var(--white);
      text-align: center;
      width: 100%;
      max-width: 300px;
      margin: 20px auto;
      display: block;
    }

    .avatar-name-input::placeholder {
      color: rgba(255,255,255,0.5);
    }

    /* ===== ä¸»ä¸–ç•Œåœ°åœ– ===== */
    .world-map {
      position: relative;
      padding: 20px;
    }

    .world-title {
      text-align: center;
      font-size: 28px;
      font-weight: 900;
      margin-bottom: 30px;
      text-shadow: 0 0 20px rgba(108, 92, 231, 0.5);
    }

    .worlds-container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
      gap: 20px;
      max-width: 1200px;
      margin: 0 auto;
    }

    .world-card {
      background: rgba(255,255,255,0.1);
      border-radius: 25px;
      padding: 25px;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
      border: 2px solid rgba(255,255,255,0.1);
    }

    .world-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      opacity: 0.1;
      z-index: 0;
    }

    .world-card.addition::before { background: var(--gradient-2); }
    .world-card.subtraction::before { background: var(--gradient-1); }
    .world-card.multiplication::before { background: var(--gradient-3); }
    .world-card.division::before { background: linear-gradient(135deg, #E17055 0%, #FDCB6E 100%); }

    .world-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--shadow);
    }

    .world-card.locked {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .world-card.locked:hover {
      transform: none;
    }

    .world-icon {
      font-size: 60px;
      margin-bottom: 15px;
      position: relative;
      z-index: 1;
    }

    .world-name {
      font-size: 24px;
      font-weight: 900;
      margin-bottom: 10px;
      position: relative;
      z-index: 1;
    }

    .world-desc {
      font-size: 14px;
      color: var(--light);
      margin-bottom: 15px;
      position: relative;
      z-index: 1;
    }

    .world-progress {
      background: rgba(255,255,255,0.2);
      border-radius: 10px;
      height: 10px;
      overflow: hidden;
      position: relative;
      z-index: 1;
    }

    .world-progress-fill {
      height: 100%;
      border-radius: 10px;
      transition: width 0.5s ease;
    }

    .world-card.addition .world-progress-fill { background: var(--gradient-2); }
    .world-card.subtraction .world-progress-fill { background: var(--gradient-1); }
    .world-card.multiplication .world-progress-fill { background: var(--gradient-3); }
    .world-card.division .world-progress-fill { background: linear-gradient(135deg, #E17055 0%, #FDCB6E 100%); }

    .world-stars {
      margin-top: 10px;
      font-size: 20px;
      position: relative;
      z-index: 1;
    }

    .lock-icon {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 60px;
      opacity: 0.8;
      z-index: 2;
    }

    /* ===== é—œå¡é¸æ“‡ ===== */
    .level-map {
      max-width: 800px;
      margin: 0 auto;
    }

    .level-path {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 20px;
      position: relative;
    }

    .level-path::before {
      content: '';
      position: absolute;
      top: 0;
      bottom: 0;
      left: 50%;
      width: 4px;
      background: rgba(255,255,255,0.2);
      transform: translateX(-50%);
      z-index: 0;
    }

    .level-node {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 28px;
      font-weight: 900;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
      z-index: 1;
      border: 4px solid transparent;
    }

    .level-node.completed {
      background: var(--gradient-2);
      box-shadow: 0 0 20px rgba(0, 206, 201, 0.5);
    }

    .level-node.current {
      background: var(--gradient-3);
      box-shadow: 0 0 30px rgba(253, 203, 110, 0.7);
      animation: pulse 2s infinite;
    }

    .level-node.locked {
      background: rgba(255,255,255,0.1);
      cursor: not-allowed;
    }

    .level-node.boss {
      width: 100px;
      height: 100px;
      font-size: 40px;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.1); }
    }

    .level-info {
      text-align: center;
      margin-top: 10px;
    }

    .back-btn {
      position: fixed;
      top: 20px;
      left: 20px;
      background: rgba(255,255,255,0.2);
      border: none;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      font-size: 24px;
      cursor: pointer;
      z-index: 100;
      transition: all 0.3s ease;
    }

    .back-btn:hover {
      background: rgba(255,255,255,0.3);
    }

    /* ===== éŠæˆ²ç•«é¢ ===== */
    .game-container {
      width: 100%;
      max-width: 600px;
      text-align: center;
    }

    .game-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 30px;
      padding: 15px 20px;
      background: rgba(0,0,0,0.3);
      border-radius: 15px;
    }

    .game-timer {
      font-size: 32px;
      font-weight: 900;
      color: var(--accent);
    }

    .game-timer.warning {
      color: var(--danger);
      animation: blink 0.5s infinite;
    }

    @keyframes blink {
      50% { opacity: 0.5; }
    }

    .game-progress {
      display: flex;
      gap: 8px;
    }

    .progress-dot {
      width: 15px;
      height: 15px;
      border-radius: 50%;
      background: rgba(255,255,255,0.2);
    }

    .progress-dot.correct {
      background: var(--success);
    }

    .progress-dot.wrong {
      background: var(--danger);
    }

    .progress-dot.current {
      background: var(--accent);
      animation: pulse 1s infinite;
    }

    .game-question-card {
      background: rgba(255,255,255,0.1);
      border-radius: 30px;
      padding: 40px;
      margin-bottom: 30px;
    }

    .game-question {
      font-size: 56px;
      font-weight: 900;
      margin-bottom: 30px;
      text-shadow: 0 0 30px rgba(108, 92, 231, 0.5);
    }

    .game-input {
      width: 100%;
      padding: 20px;
      font-size: 36px;
      text-align: center;
      border: none;
      border-radius: 20px;
      background: rgba(255,255,255,0.9);
      color: var(--dark);
      font-weight: 700;
    }

    .game-input:focus {
      outline: none;
      box-shadow: 0 0 30px rgba(253, 203, 110, 0.5);
    }

    .game-keypad {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      max-width: 400px;
      margin: 0 auto;
    }

    .keypad-btn {
      padding: 20px;
      font-size: 28px;
      font-weight: 700;
      border: none;
      border-radius: 15px;
      background: rgba(255,255,255,0.1);
      color: var(--white);
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .keypad-btn:hover {
      background: rgba(255,255,255,0.2);
    }

    .keypad-btn:active {
      transform: scale(0.95);
    }

    .keypad-btn.submit {
      background: var(--gradient-2);
      color: var(--dark);
    }

    .keypad-btn.clear {
      background: var(--gradient-1);
    }

    .keypad-btn.negative {
      background: rgba(225, 112, 85, 0.5);
    }

    /* ===== çµæœç•«é¢ ===== */
    .result-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0,0,0,0.9);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      animation: fadeIn 0.3s ease;
    }

    .result-card {
      background: rgba(255,255,255,0.1);
      border-radius: 30px;
      padding: 40px;
      text-align: center;
      max-width: 400px;
      width: 90%;
    }

    .result-icon {
      font-size: 80px;
      margin-bottom: 20px;
    }

    .result-title {
      font-size: 32px;
      font-weight: 900;
      margin-bottom: 20px;
    }

    .result-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      margin-bottom: 30px;
    }

    .stat-item {
      background: rgba(255,255,255,0.1);
      padding: 15px;
      border-radius: 15px;
    }

    .stat-value {
      font-size: 28px;
      font-weight: 900;
      color: var(--accent);
    }

    .stat-label {
      font-size: 12px;
      color: var(--light);
    }

    .rewards-section {
      background: rgba(253, 203, 110, 0.2);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .reward-item {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      font-size: 20px;
      font-weight: 700;
    }

    /* ===== ä»»å‹™ç•«é¢ ===== */
    .quest-section {
      margin-bottom: 30px;
    }

    .quest-section-title {
      font-size: 20px;
      font-weight: 900;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .quest-card {
      background: rgba(255,255,255,0.1);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 15px;
      transition: all 0.3s ease;
    }

    .quest-card:hover {
      background: rgba(255,255,255,0.15);
    }

    .quest-icon {
      font-size: 40px;
    }

    .quest-info {
      flex: 1;
    }

    .quest-name {
      font-weight: 700;
      margin-bottom: 5px;
    }

    .quest-progress-bar {
      background: rgba(255,255,255,0.2);
      height: 8px;
      border-radius: 10px;
      overflow: hidden;
    }

    .quest-progress-fill {
      height: 100%;
      background: var(--gradient-2);
      transition: width 0.3s ease;
    }

    .quest-reward {
      display: flex;
      align-items: center;
      gap: 5px;
      color: var(--accent);
      font-weight: 700;
    }

    .quest-card.completed {
      opacity: 0.6;
    }

    .quest-card.completed .quest-progress-fill {
      background: var(--success);
    }

    /* ===== å•†åº—ç•«é¢ ===== */
    .shop-categories {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      overflow-x: auto;
      padding-bottom: 10px;
    }

    .shop-category {
      padding: 10px 20px;
      border-radius: 20px;
      background: rgba(255,255,255,0.1);
      border: none;
      color: var(--white);
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.3s ease;
    }

    .shop-category.active {
      background: var(--gradient-3);
      color: var(--dark);
    }

    .shop-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      gap: 15px;
    }

    .shop-item {
      background: rgba(255,255,255,0.1);
      border-radius: 20px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      border: 2px solid transparent;
    }

    .shop-item:hover {
      transform: translateY(-5px);
      background: rgba(255,255,255,0.15);
    }

    .shop-item.owned {
      border-color: var(--success);
    }

    .shop-item.equipped {
      border-color: var(--accent);
      background: rgba(253, 203, 110, 0.2);
    }

    .shop-item-icon {
      font-size: 50px;
      margin-bottom: 10px;
    }

    .shop-item-name {
      font-weight: 700;
      margin-bottom: 10px;
      font-size: 14px;
    }

    .shop-item-price {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      color: var(--accent);
      font-weight: 700;
    }

    .shop-item-price.owned {
      color: var(--success);
    }

    /* ===== è§’è‰²ç•«é¢ ===== */
    .avatar-display {
      text-align: center;
      margin-bottom: 30px;
    }

    .avatar-big {
      font-size: 120px;
      margin-bottom: 20px;
    }

    .avatar-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      max-width: 400px;
      margin: 0 auto 30px;
    }

    .avatar-stat {
      background: rgba(255,255,255,0.1);
      border-radius: 15px;
      padding: 20px;
      text-align: center;
    }

    .avatar-stat-value {
      font-size: 32px;
      font-weight: 900;
      color: var(--accent);
    }

    .avatar-stat-label {
      font-size: 14px;
      color: var(--light);
    }

    .exp-bar {
      background: rgba(255,255,255,0.2);
      border-radius: 15px;
      height: 25px;
      overflow: hidden;
      margin-bottom: 10px;
    }

    .exp-bar-fill {
      height: 100%;
      background: var(--gradient-3);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 12px;
      transition: width 0.5s ease;
    }

    .equipment-section {
      margin-top: 30px;
    }

    .equipment-slots {
      display: flex;
      justify-content: center;
      gap: 15px;
      flex-wrap: wrap;
    }

    .equipment-slot {
      width: 80px;
      height: 80px;
      background: rgba(255,255,255,0.1);
      border-radius: 15px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .equipment-slot:hover {
      background: rgba(255,255,255,0.2);
    }

    .equipment-slot-icon {
      font-size: 30px;
    }

    .equipment-slot-label {
      font-size: 10px;
      color: var(--light);
    }

    /* ===== åº•éƒ¨å°èˆª ===== */
    .bottom-nav {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: rgba(0,0,0,0.9);
      backdrop-filter: blur(10px);
      display: flex;
      justify-content: space-around;
      padding: 10px 20px;
      padding-bottom: max(10px, env(safe-area-inset-bottom));
      z-index: 100;
    }

    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 5px;
      padding: 10px 20px;
      border-radius: 15px;
      cursor: pointer;
      transition: all 0.3s ease;
      background: transparent;
      border: none;
      color: var(--light);
    }

    .nav-item.active {
      background: rgba(255,255,255,0.1);
      color: var(--accent);
    }

    .nav-icon {
      font-size: 24px;
    }

    .nav-label {
      font-size: 12px;
      font-weight: 700;
    }

    /* ===== å®¶é•·ç«¯æ¨£å¼ ===== */
    .parent-header {
      background: var(--gradient-1);
      margin: -20px -20px 20px -20px;
      padding: 30px 20px;
      text-align: center;
    }

    .parent-title {
      font-size: 24px;
      font-weight: 900;
    }

    .parent-subtitle {
      font-size: 14px;
      opacity: 0.8;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: rgba(255,255,255,0.1);
      border-radius: 20px;
      padding: 20px;
      text-align: center;
    }

    .stat-card-value {
      font-size: 36px;
      font-weight: 900;
      color: var(--accent);
    }

    .stat-card-label {
      font-size: 14px;
      color: var(--light);
    }

    .chart-container {
      background: rgba(255,255,255,0.1);
      border-radius: 20px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .chart-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 15px;
    }

    .chart-bars {
      display: flex;
      align-items: flex-end;
      justify-content: space-around;
      height: 150px;
      gap: 10px;
    }

    .chart-bar {
      flex: 1;
      background: var(--gradient-2);
      border-radius: 10px 10px 0 0;
      position: relative;
      transition: height 0.5s ease;
    }

    .chart-bar-label {
      position: absolute;
      bottom: -25px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 12px;
      color: var(--light);
    }

    .settings-section {
      margin-bottom: 30px;
    }

    .settings-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 15px;
    }

    .setting-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: rgba(255,255,255,0.1);
      border-radius: 15px;
      margin-bottom: 10px;
    }

    .setting-label {
      font-weight: 700;
    }

    .setting-value {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .toggle-switch {
      width: 50px;
      height: 26px;
      background: rgba(255,255,255,0.2);
      border-radius: 13px;
      position: relative;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .toggle-switch.active {
      background: var(--success);
    }

    .toggle-switch::after {
      content: '';
      width: 22px;
      height: 22px;
      background: var(--white);
      border-radius: 50%;
      position: absolute;
      top: 2px;
      left: 2px;
      transition: all 0.3s ease;
    }

    .toggle-switch.active::after {
      left: 26px;
    }

    .number-input {
      width: 80px;
      padding: 8px;
      border: none;
      border-radius: 10px;
      background: rgba(255,255,255,0.2);
      color: var(--white);
      text-align: center;
      font-size: 16px;
      font-weight: 700;
    }

    .mastery-list {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .mastery-item {
      display: flex;
      align-items: center;
      gap: 15px;
      padding: 15px;
      background: rgba(255,255,255,0.1);
      border-radius: 15px;
    }

    .mastery-icon {
      font-size: 30px;
    }

    .mastery-info {
      flex: 1;
    }

    .mastery-name {
      font-weight: 700;
      margin-bottom: 5px;
    }

    .mastery-bar {
      background: rgba(255,255,255,0.2);
      height: 10px;
      border-radius: 5px;
      overflow: hidden;
    }

    .mastery-fill {
      height: 100%;
      border-radius: 5px;
      transition: width 0.5s ease;
    }

    .mastery-fill.low { background: var(--danger); }
    .mastery-fill.medium { background: var(--accent); }
    .mastery-fill.high { background: var(--success); }

    .mastery-percent {
      font-weight: 700;
      min-width: 50px;
      text-align: right;
    }

    .logout-btn {
      width: 100%;
      margin-top: 30px;
    }

    /* ===== éŸ¿æ‡‰å¼è¨­è¨ˆ ===== */
    @media (max-width: 600px) {
      .logo {
        font-size: 36px;
      }

      .game-question {
        font-size: 40px;
      }

      .avatar-selection {
        grid-template-columns: repeat(2, 1fr);
      }

      .top-bar {
        flex-direction: column;
        gap: 10px;
      }

      .currency-display {
        width: 100%;
        justify-content: center;
      }

      .player-info {
        width: 100%;
        justify-content: center;
      }
    }

    /* ===== å‹•ç•«æ•ˆæœ ===== */
    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }

    @keyframes glow {
      0%, 100% { box-shadow: 0 0 20px rgba(253, 203, 110, 0.5); }
      50% { box-shadow: 0 0 40px rgba(253, 203, 110, 0.8); }
    }

    .bounce { animation: bounce 0.5s ease; }
    .shake { animation: shake 0.3s ease; }
    .glow { animation: glow 2s infinite; }

    /* ===== éµç›¤å°èˆª ===== */
    .kb-focus {
      outline: 3px solid #FDCB6E !important;
      outline-offset: 3px;
      box-shadow: 0 0 15px rgba(253, 203, 110, 0.6) !important;
    }

    /* ===== éš±è—å…ƒç´  ===== */
    .hidden {
      display: none !important;
    }
  </style>
</head>
<body>
  <!-- ===== ç™»å…¥ç•«é¢ ===== -->
  <div id="login-screen" class="screen no-nav active">
    <div class="logo">JaxonLearn</div>
    <div class="logo-subtitle">æ•¸å­¸å†’éšªç‹åœ‹</div>
    <div class="login-buttons">
      <button class="btn login-btn btn-primary" onclick="showKidLogin()">
        <span class="icon">ğŸ®</span>
        <span>å°å‹‡å£«å…¥å£</span>
      </button>
      <button class="btn login-btn btn-secondary" onclick="showParentLogin()">
        <span class="icon">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§</span>
        <span>å®¶é•·å…¥å£</span>
      </button>
    </div>
  </div>

  <!-- ===== è§’è‰²å‰µå»ºç•«é¢ ===== -->
  <div id="create-avatar-screen" class="screen no-nav">
    <h1 style="text-align: center; margin-bottom: 10px;">é¸æ“‡ä½ çš„è§’è‰²</h1>
    <p style="text-align: center; color: var(--light); margin-bottom: 20px;">æŒ‘é¸ä¸€å€‹æœ€é…·çš„è§’è‰²é–‹å§‹å†’éšªï¼</p>

    <div class="avatar-selection" id="avatar-selection">
      <div class="avatar-option" data-avatar="ğŸ¦¸â€â™‚ï¸" onclick="selectAvatar(this)">
        <div class="avatar-preview">ğŸ¦¸â€â™‚ï¸</div>
        <div>è¶…ç´šè‹±é›„</div>
      </div>
      <div class="avatar-option" data-avatar="ğŸ§™â€â™‚ï¸" onclick="selectAvatar(this)">
        <div class="avatar-preview">ğŸ§™â€â™‚ï¸</div>
        <div>é­”æ³•å¸«</div>
      </div>
      <div class="avatar-option" data-avatar="ğŸ¥·" onclick="selectAvatar(this)">
        <div class="avatar-preview">ğŸ¥·</div>
        <div>å¿è€…</div>
      </div>
      <div class="avatar-option" data-avatar="ğŸ¤–" onclick="selectAvatar(this)">
        <div class="avatar-preview">ğŸ¤–</div>
        <div>æ©Ÿå™¨äºº</div>
      </div>
      <div class="avatar-option" data-avatar="ğŸ§‘â€ğŸš€" onclick="selectAvatar(this)">
        <div class="avatar-preview">ğŸ§‘â€ğŸš€</div>
        <div>å¤ªç©ºäºº</div>
      </div>
      <div class="avatar-option" data-avatar="ğŸ¦Š" onclick="selectAvatar(this)">
        <div class="avatar-preview">ğŸ¦Š</div>
        <div>ç‹ç‹¸ä¿ </div>
      </div>
    </div>

    <input type="text" class="avatar-name-input" id="player-name-input" placeholder="è¼¸å…¥ä½ çš„æš±ç¨±" maxlength="10">

    <div style="text-align: center; margin-top: 20px;">
      <button class="btn btn-accent" onclick="createAvatar()">é–‹å§‹å†’éšªï¼</button>
    </div>
  </div>

  <!-- ===== å­©å­ç«¯ä¸»ç•«é¢ ===== -->
  <div id="kid-main-screen" class="screen">
    <div class="top-bar">
      <div class="currency-display">
        <div class="currency-item">
          <span class="currency-icon">ğŸª™</span>
          <span id="display-coins">0</span>
        </div>
        <div class="currency-item">
          <span class="currency-icon">âš¡</span>
          <span id="display-energy">100</span>
        </div>
      </div>
      <div class="player-info">
        <span class="player-level" id="display-level">Lv.1</span>
        <span class="player-name" id="display-name">å‹‡å£«</span>
        <div class="exp-bar-mini">
          <div class="exp-bar-mini-fill" id="display-exp-bar" style="width: 0%"></div>
        </div>
      </div>
    </div>

    <!-- ä¸–ç•Œåœ°åœ– -->
    <div id="world-map-view" class="world-map">
      <h1 class="world-title">ğŸ—ºï¸ é¸æ“‡ä½ çš„å†’éšªä¸–ç•Œ</h1>
      <div class="worlds-container" id="worlds-container"></div>
    </div>

    <!-- é—œå¡é¸æ“‡ -->
    <div id="level-select-view" class="hidden">
      <button class="back-btn" onclick="backToWorldMap()">â†</button>
      <h1 class="world-title" id="current-world-title">åŠ æ³•æ‘</h1>
      <div class="level-map">
        <div class="level-path" id="level-path"></div>
      </div>
    </div>

    <!-- åº•éƒ¨å°èˆª -->
    <nav class="bottom-nav">
      <button class="nav-item active" data-tab="map" onclick="switchTab('map')">
        <span class="nav-icon">ğŸ—ºï¸</span>
        <span class="nav-label">åœ°åœ–</span>
      </button>
      <button class="nav-item" data-tab="quest" onclick="switchTab('quest')">
        <span class="nav-icon">ğŸ“œ</span>
        <span class="nav-label">ä»»å‹™</span>
      </button>
      <button class="nav-item" data-tab="shop" onclick="switchTab('shop')">
        <span class="nav-icon">ğŸª</span>
        <span class="nav-label">å•†åº—</span>
      </button>
      <button class="nav-item" data-tab="avatar" onclick="switchTab('avatar')">
        <span class="nav-icon">ğŸ‘¤</span>
        <span class="nav-label">è§’è‰²</span>
      </button>
    </nav>
  </div>

  <!-- ===== ä»»å‹™ç•«é¢ ===== -->
  <div id="quest-screen" class="screen">
    <div class="top-bar">
      <div class="currency-display">
        <div class="currency-item">
          <span class="currency-icon">ğŸª™</span>
          <span class="coins-display">0</span>
        </div>
        <div class="currency-item">
          <span class="currency-icon">âš¡</span>
          <span class="energy-display">100</span>
        </div>
      </div>
    </div>

    <h1 style="text-align: center; margin-bottom: 20px;">ğŸ“œ ä»»å‹™ä¸­å¿ƒ</h1>

    <div class="quest-section">
      <div class="quest-section-title">ğŸŒŸ æ¯æ—¥ä»»å‹™</div>
      <div id="daily-quests"></div>
    </div>

    <div class="quest-section">
      <div class="quest-section-title">âš”ï¸ ä¸»ç·šä»»å‹™</div>
      <div id="main-quests"></div>
    </div>

    <nav class="bottom-nav">
      <button class="nav-item" data-tab="map" onclick="switchTab('map')">
        <span class="nav-icon">ğŸ—ºï¸</span>
        <span class="nav-label">åœ°åœ–</span>
      </button>
      <button class="nav-item active" data-tab="quest" onclick="switchTab('quest')">
        <span class="nav-icon">ğŸ“œ</span>
        <span class="nav-label">ä»»å‹™</span>
      </button>
      <button class="nav-item" data-tab="shop" onclick="switchTab('shop')">
        <span class="nav-icon">ğŸª</span>
        <span class="nav-label">å•†åº—</span>
      </button>
      <button class="nav-item" data-tab="avatar" onclick="switchTab('avatar')">
        <span class="nav-icon">ğŸ‘¤</span>
        <span class="nav-label">è§’è‰²</span>
      </button>
    </nav>
  </div>

  <!-- ===== å•†åº—ç•«é¢ ===== -->
  <div id="shop-screen" class="screen">
    <div class="top-bar">
      <div class="currency-display">
        <div class="currency-item">
          <span class="currency-icon">ğŸª™</span>
          <span class="coins-display">0</span>
        </div>
      </div>
    </div>

    <h1 style="text-align: center; margin-bottom: 20px;">ğŸª é€ å‹å•†åº—</h1>

    <div class="shop-categories">
      <button class="shop-category active" data-category="hair" onclick="switchShopCategory('hair')">é«®å‹</button>
      <button class="shop-category" data-category="clothes" onclick="switchShopCategory('clothes')">è¡£æœ</button>
      <button class="shop-category" data-category="accessory" onclick="switchShopCategory('accessory')">é…ä»¶</button>
      <button class="shop-category" data-category="pet" onclick="switchShopCategory('pet')">å¯µç‰©</button>
    </div>

    <div class="shop-grid" id="shop-items"></div>

    <nav class="bottom-nav">
      <button class="nav-item" data-tab="map" onclick="switchTab('map')">
        <span class="nav-icon">ğŸ—ºï¸</span>
        <span class="nav-label">åœ°åœ–</span>
      </button>
      <button class="nav-item" data-tab="quest" onclick="switchTab('quest')">
        <span class="nav-icon">ğŸ“œ</span>
        <span class="nav-label">ä»»å‹™</span>
      </button>
      <button class="nav-item active" data-tab="shop" onclick="switchTab('shop')">
        <span class="nav-icon">ğŸª</span>
        <span class="nav-label">å•†åº—</span>
      </button>
      <button class="nav-item" data-tab="avatar" onclick="switchTab('avatar')">
        <span class="nav-icon">ğŸ‘¤</span>
        <span class="nav-label">è§’è‰²</span>
      </button>
    </nav>
  </div>

  <!-- ===== è§’è‰²ç•«é¢ ===== -->
  <div id="avatar-screen" class="screen">
    <div class="avatar-display">
      <div class="avatar-big" id="avatar-display-big">ğŸ¦¸â€â™‚ï¸</div>
      <h2 id="avatar-display-name">å‹‡å£«</h2>
      <div class="player-level" id="avatar-display-level" style="display: inline-block; margin-top: 10px;">Lv.1</div>
    </div>

    <div class="exp-bar">
      <div class="exp-bar-fill" id="avatar-exp-bar" style="width: 0%">0 / 100 EXP</div>
    </div>

    <div class="avatar-stats">
      <div class="avatar-stat">
        <div class="avatar-stat-value" id="stat-total-stars">0</div>
        <div class="avatar-stat-label">ç²å¾—æ˜Ÿæ˜Ÿ</div>
      </div>
      <div class="avatar-stat">
        <div class="avatar-stat-value" id="stat-total-levels">0</div>
        <div class="avatar-stat-label">å®Œæˆé—œå¡</div>
      </div>
      <div class="avatar-stat">
        <div class="avatar-stat-value" id="stat-accuracy">0%</div>
        <div class="avatar-stat-label">æ­£ç¢ºç‡</div>
      </div>
      <div class="avatar-stat">
        <div class="avatar-stat-value" id="stat-streak">0</div>
        <div class="avatar-stat-label">é€£çºŒç™»å…¥</div>
      </div>
    </div>

    <div class="equipment-section">
      <h3 style="text-align: center; margin-bottom: 15px;">è£å‚™æ¬„</h3>
      <div class="equipment-slots">
        <div class="equipment-slot" id="equip-hair">
          <span class="equipment-slot-icon">ğŸ’‡</span>
          <span class="equipment-slot-label">é«®å‹</span>
        </div>
        <div class="equipment-slot" id="equip-clothes">
          <span class="equipment-slot-icon">ğŸ‘•</span>
          <span class="equipment-slot-label">è¡£æœ</span>
        </div>
        <div class="equipment-slot" id="equip-accessory">
          <span class="equipment-slot-icon">ğŸ€</span>
          <span class="equipment-slot-label">é…ä»¶</span>
        </div>
        <div class="equipment-slot" id="equip-pet">
          <span class="equipment-slot-icon">ğŸ¾</span>
          <span class="equipment-slot-label">å¯µç‰©</span>
        </div>
      </div>
    </div>

    <nav class="bottom-nav">
      <button class="nav-item" data-tab="map" onclick="switchTab('map')">
        <span class="nav-icon">ğŸ—ºï¸</span>
        <span class="nav-label">åœ°åœ–</span>
      </button>
      <button class="nav-item" data-tab="quest" onclick="switchTab('quest')">
        <span class="nav-icon">ğŸ“œ</span>
        <span class="nav-label">ä»»å‹™</span>
      </button>
      <button class="nav-item" data-tab="shop" onclick="switchTab('shop')">
        <span class="nav-icon">ğŸª</span>
        <span class="nav-label">å•†åº—</span>
      </button>
      <button class="nav-item active" data-tab="avatar" onclick="switchTab('avatar')">
        <span class="nav-icon">ğŸ‘¤</span>
        <span class="nav-label">è§’è‰²</span>
      </button>
    </nav>
  </div>

  <!-- ===== éŠæˆ²ç•«é¢ ===== -->
  <div id="game-screen" class="screen no-nav">
    <div class="game-container">
      <div class="game-header">
        <div class="game-timer" id="game-timer">60</div>
        <div class="game-progress" id="game-progress"></div>
        <div style="font-weight: 700;">
          é—œå¡ <span id="game-level-display">1</span>
        </div>
      </div>

      <div class="game-question-card">
        <div class="game-question" id="game-question">12 + 8</div>
        <input type="text" class="game-input" id="game-input" inputmode="numeric" pattern="[0-9-]*" readonly>
      </div>

      <div class="game-keypad">
        <button class="keypad-btn" onclick="inputNumber('1')">1</button>
        <button class="keypad-btn" onclick="inputNumber('2')">2</button>
        <button class="keypad-btn" onclick="inputNumber('3')">3</button>
        <button class="keypad-btn" onclick="inputNumber('4')">4</button>
        <button class="keypad-btn" onclick="inputNumber('5')">5</button>
        <button class="keypad-btn" onclick="inputNumber('6')">6</button>
        <button class="keypad-btn" onclick="inputNumber('7')">7</button>
        <button class="keypad-btn" onclick="inputNumber('8')">8</button>
        <button class="keypad-btn" onclick="inputNumber('9')">9</button>
        <button class="keypad-btn negative" onclick="inputNumber('-')">âˆ’</button>
        <button class="keypad-btn" onclick="inputNumber('0')">0</button>
        <button class="keypad-btn clear" onclick="clearInput()">âŒ«</button>
        <button class="keypad-btn submit" onclick="submitAnswer()" style="grid-column: span 3;">ç¢ºèªç­”æ¡ˆ</button>
      </div>
    </div>
  </div>

  <!-- ===== çµæœå½ˆçª— ===== -->
  <div id="result-overlay" class="result-overlay hidden">
    <div class="result-card">
      <div class="result-icon" id="result-icon">ğŸ‰</div>
      <div class="result-title" id="result-title">å¤ªæ£’äº†ï¼</div>

      <div class="result-stats">
        <div class="stat-item">
          <div class="stat-value" id="result-correct">5</div>
          <div class="stat-label">ç­”å°é¡Œæ•¸</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="result-time">45ç§’</div>
          <div class="stat-label">å®Œæˆæ™‚é–“</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="result-accuracy">100%</div>
          <div class="stat-label">æ­£ç¢ºç‡</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="result-stars">â­â­â­</div>
          <div class="stat-label">ç²å¾—æ˜Ÿæ˜Ÿ</div>
        </div>
      </div>

      <div class="rewards-section">
        <div class="reward-item">
          <span>ğŸª™</span>
          <span id="result-coins">+50</span>
          <span>é‡‘å¹£</span>
        </div>
        <div class="reward-item">
          <span>âœ¨</span>
          <span id="result-exp">+30</span>
          <span>ç¶“é©—å€¼</span>
        </div>
      </div>

      <button class="btn btn-primary" onclick="closeResult()" style="width: 100%;">ç¹¼çºŒå†’éšª</button>
    </div>
  </div>

  <!-- ===== å®¶é•·ç«¯ç•«é¢ ===== -->
  <div id="parent-screen" class="screen no-nav">
    <div class="parent-header">
      <div class="parent-title">ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ å®¶é•·æ§åˆ¶å°</div>
      <div class="parent-subtitle">JaxonLearn å­¸ç¿’ç®¡ç†ç³»çµ±</div>
    </div>

    <div class="stats-grid">
      <div class="stat-card">
        <div class="stat-card-value" id="parent-total-time">0</div>
        <div class="stat-card-label">ä»Šæ—¥å­¸ç¿’(åˆ†é˜)</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-value" id="parent-total-levels">0</div>
        <div class="stat-card-label">å®Œæˆé—œå¡</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-value" id="parent-accuracy">0%</div>
        <div class="stat-card-label">æ­£ç¢ºç‡</div>
      </div>
      <div class="stat-card">
        <div class="stat-card-value" id="parent-streak">0</div>
        <div class="stat-card-label">é€£çºŒç™»å…¥</div>
      </div>
    </div>

    <div class="chart-container">
      <div class="chart-title">ğŸ“Š æœ¬é€±å­¸ç¿’æ™‚é–“</div>
      <div class="chart-bars" id="weekly-chart"></div>
    </div>

    <div class="chart-container">
      <div class="chart-title">ğŸ“ˆ æŠ€èƒ½æŒæ¡åº¦</div>
      <div class="mastery-list" id="mastery-list"></div>
    </div>

    <div class="settings-section">
      <div class="settings-title">âš™ï¸ è¨­å®š</div>

      <div class="setting-item">
        <span class="setting-label">æ¯æ—¥æ™‚é–“é™åˆ¶</span>
        <div class="setting-value">
          <input type="number" class="number-input" id="time-limit" value="60" min="10" max="180"> åˆ†é˜
        </div>
      </div>

      <div class="setting-item">
        <span class="setting-label">æ¯æ—¥é—œå¡ä¸Šé™</span>
        <div class="setting-value">
          <input type="number" class="number-input" id="level-limit" value="20" min="5" max="50"> é—œ
        </div>
      </div>

      <div class="setting-item">
        <span class="setting-label">å…è¨±ç¤¾äº¤åŠŸèƒ½</span>
        <div class="setting-value">
          <div class="toggle-switch" id="social-toggle" onclick="toggleSetting('social')"></div>
        </div>
      </div>

      <div class="setting-item">
        <span class="setting-label">é¡¯ç¤ºæ’è¡Œæ¦œ</span>
        <div class="setting-value">
          <div class="toggle-switch" id="leaderboard-toggle" onclick="toggleSetting('leaderboard')"></div>
        </div>
      </div>
    </div>

    <button class="btn btn-primary" onclick="saveParentSettings()" style="width: 100%; margin-bottom: 15px;">å„²å­˜è¨­å®š</button>
    <button class="btn btn-secondary logout-btn" onclick="parentLogout()">è¿”å›é¦–é </button>
  </div>

  <!-- ===== Firebase SDK ===== -->
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.7.0/firebase-firestore-compat.js"></script>
  <script>
    // Firebase é…ç½®
    let db = null;
    try {
      const firebaseConfig = {
        apiKey: "AIzaSyBFVYr5xZ9r5THe5ZJL9iG3cyrvLsyQzGg",
        authDomain: "jaxonlearn-47d74.firebaseapp.com",
        projectId: "jaxonlearn-47d74",
        storageBucket: "jaxonlearn-47d74.firebasestorage.app",
        messagingSenderId: "155229206941",
        appId: "1:155229206941:web:5cc0a06af8c0956a9fc328"
      };
      firebase.initializeApp(firebaseConfig);
      db = firebase.firestore();
      console.log('Firebase é€£æ¥æˆåŠŸï¼');
    } catch (e) {
      console.log('Firebase é›¢ç·šæ¨¡å¼ï¼Œä½¿ç”¨æœ¬åœ°å„²å­˜');
    }

    // ========== éŠæˆ²ç‹€æ…‹ ==========
    window.gameState = {
      // ç©å®¶åŸºæœ¬è³‡æ–™
      playerId: localStorage.getItem('jaxon_player_id') || null,
      playerName: 'å‹‡å£«',
      avatar: 'ğŸ¦¸â€â™‚ï¸',
      level: 1,
      exp: 0,
      expToNext: 100,
      coins: 0,
      energy: 100,
      maxEnergy: 100,

      // éŠæˆ²é€²åº¦
      worldProgress: {
        addition: { unlocked: true, completed: 0, stars: 0 },
        subtraction: { unlocked: false, completed: 0, stars: 0 },
        multiplication: { unlocked: false, completed: 0, stars: 0 },
        division: { unlocked: false, completed: 0, stars: 0 }
      },

      // çµ±è¨ˆæ•¸æ“š
      stats: {
        totalStars: 0,
        totalLevels: 0,
        totalCorrect: 0,
        totalQuestions: 0,
        loginStreak: 0,
        lastLogin: null,
        todayPlayTime: 0,
        weeklyPlayTime: [0, 0, 0, 0, 0, 0, 0]
      },

      // æ“æœ‰çš„ç‰©å“
      inventory: {
        hair: [],
        clothes: [],
        accessory: [],
        pet: []
      },

      // è£å‚™ä¸­çš„ç‰©å“
      equipped: {
        hair: null,
        clothes: null,
        accessory: null,
        pet: null
      },

      // ä»»å‹™é€²åº¦
      quests: {
        daily: [],
        main: []
      },

      // å®¶é•·è¨­å®š
      parentSettings: {
        timeLimit: 60,
        levelLimit: 20,
        socialEnabled: false,
        leaderboardEnabled: false
      },

      // ç•¶å‰éŠæˆ²ç‹€æ…‹
      currentWorld: null,
      currentLevel: 0,
      currentGame: null
    };

    // ========== ä¸–ç•Œé…ç½® ==========
    const WORLDS = {
      addition: {
        id: 'addition',
        name: 'åŠ æ³•æ‘',
        icon: 'ğŸ¡',
        desc: 'åœ¨å’Œå¹³çš„æ‘èŠå­¸ç¿’åŠ æ³•çš„å¥§ç§˜',
        color: 'addition',
        levels: 10,
        unlockRequirement: null,
        generateQuestion: (level) => {
          const max = 10 + level * 5;
          const a = Math.floor(Math.random() * max) + 1;
          const b = Math.floor(Math.random() * max) + 1;
          return { question: `${a} + ${b}`, answer: a + b };
        }
      },
      subtraction: {
        id: 'subtraction',
        name: 'æ¸›æ³•æ£®æ—',
        icon: 'ğŸŒ²',
        desc: 'åœ¨ç¥ç§˜æ£®æ—ä¸­æŒ‘æˆ°æ¸›æ³•é›£é¡Œ',
        color: 'subtraction',
        levels: 10,
        unlockRequirement: { world: 'addition', level: 5 },
        generateQuestion: (level) => {
          const max = 10 + level * 5;
          const a = Math.floor(Math.random() * max) + 10;
          const b = Math.floor(Math.random() * Math.min(a, max)) + 1;
          return { question: `${a} - ${b}`, answer: a - b };
        }
      },
      multiplication: {
        id: 'multiplication',
        name: 'ä¹˜æ³•åŸå ¡',
        icon: 'ğŸ°',
        desc: 'æ”»å åŸå ¡ï¼Œå¾æœä¹˜æ³•ï¼',
        color: 'multiplication',
        levels: 10,
        unlockRequirement: { world: 'subtraction', level: 5 },
        generateQuestion: (level) => {
          const max = Math.min(2 + level, 12);
          const a = Math.floor(Math.random() * max) + 1;
          const b = Math.floor(Math.random() * max) + 1;
          return { question: `${a} Ã— ${b}`, answer: a * b };
        }
      },
      division: {
        id: 'division',
        name: 'é™¤æ³•ç«å±±',
        icon: 'ğŸŒ‹',
        desc: 'åœ¨ç«å±±æ·±è™•ç ´è§£é™¤æ³•å¯†ç¢¼',
        color: 'division',
        levels: 10,
        unlockRequirement: { world: 'multiplication', level: 5 },
        generateQuestion: (level) => {
          const max = Math.min(2 + level, 12);
          const b = Math.floor(Math.random() * max) + 1;
          const answer = Math.floor(Math.random() * max) + 1;
          const a = b * answer;
          return { question: `${a} Ã· ${b}`, answer: answer };
        }
      }
    };

    // ========== å•†åº—ç‰©å“ ==========
    const SHOP_ITEMS = {
      hair: [
        { id: 'hair1', name: 'é…·ç‚«åˆºèŸé ­', icon: 'ğŸ’‡â€â™‚ï¸', price: 50 },
        { id: 'hair2', name: 'å¸¥æ°£é£›æ©Ÿé ­', icon: 'ğŸ’‡', price: 80 },
        { id: 'hair3', name: 'éœ¸æ°£ç…å­é ­', icon: 'ğŸ¦', price: 150 },
        { id: 'hair4', name: 'å½©è™¹é«®', icon: 'ğŸŒˆ', price: 200 }
      ],
      clothes: [
        { id: 'clothes1', name: 'è¶…ç´šè‹±é›„è£', icon: 'ğŸ¦¸', price: 100 },
        { id: 'clothes2', name: 'å¤ªç©ºè£', icon: 'ğŸ‘¨â€ğŸš€', price: 150 },
        { id: 'clothes3', name: 'å¿è€…æœ', icon: 'ğŸ¥·', price: 120 },
        { id: 'clothes4', name: 'çš‡å®¶ç›”ç”²', icon: 'ğŸ›¡ï¸', price: 250 }
      ],
      accessory: [
        { id: 'acc1', name: 'é…·é…·å¢¨é¡', icon: 'ğŸ•¶ï¸', price: 30 },
        { id: 'acc2', name: 'é–ƒäº®çš‡å† ', icon: 'ğŸ‘‘', price: 200 },
        { id: 'acc3', name: 'ç¥ç§˜é¢å…·', icon: 'ğŸ­', price: 80 },
        { id: 'acc4', name: 'ç¿…è†€èƒŒé£¾', icon: 'ğŸª½', price: 300 }
      ],
      pet: [
        { id: 'pet1', name: 'å°ç‹—å¤¥ä¼´', icon: 'ğŸ•', price: 150 },
        { id: 'pet2', name: 'è²“å’ªåŠ©æ‰‹', icon: 'ğŸˆ', price: 150 },
        { id: 'pet3', name: 'ç«é¾å¯¶å¯¶', icon: 'ğŸ‰', price: 500 },
        { id: 'pet4', name: 'ç¨è§’ç¸', icon: 'ğŸ¦„', price: 800 }
      ]
    };

    // ========== ä»»å‹™ç³»çµ± ==========
    function generateDailyQuests() {
      const quests = [
        { id: 'daily1', name: 'å®Œæˆ3å€‹é—œå¡', icon: 'ğŸ¯', target: 3, current: 0, reward: 30, type: 'levels' },
        { id: 'daily2', name: 'ç­”å°15é¡Œ', icon: 'âœ…', target: 15, current: 0, reward: 25, type: 'correct' },
        { id: 'daily3', name: 'ç²å¾—1é¡†æ˜Ÿæ˜Ÿ', icon: 'â­', target: 1, current: 0, reward: 20, type: 'stars' }
      ];
      return quests;
    }

    function generateMainQuests() {
      const quests = [
        { id: 'main1', name: 'å®ŒæˆåŠ æ³•æ‘ç¬¬1é—œ', icon: 'ğŸ¡', world: 'addition', level: 1, completed: false, reward: 50 },
        { id: 'main2', name: 'è§£é–æ¸›æ³•æ£®æ—', icon: 'ğŸŒ²', world: 'addition', level: 5, completed: false, reward: 100 },
        { id: 'main3', name: 'å¾æœä¹˜æ³•åŸå ¡å…¥å£', icon: 'ğŸ°', world: 'multiplication', level: 1, completed: false, reward: 150 }
      ];
      return quests;
    }

    // ========== ç•«é¢åˆ‡æ› ==========
    window.showScreen = function(screenId) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      document.getElementById(screenId).classList.add('active');
    }

    window.showKidLogin = function() {
      if (gameState.playerId) {
        loadPlayerData().then(() => {
          showScreen('kid-main-screen');
          renderWorldMap();
          updateDisplays();
        }).catch((error) => {
          console.error('è¼‰å…¥å¤±æ•—:', error);
          showScreen('kid-main-screen');
          renderWorldMap();
          updateDisplays();
        });
      } else {
        showScreen('create-avatar-screen');
      }
    }

    window.showParentLogin = function() {
      const password = prompt('è«‹è¼¸å…¥å®¶é•·å¯†ç¢¼ï¼ˆé è¨­ï¼š1234ï¼‰ï¼š');
      if (password === '1234') {
        showScreen('parent-screen');
        renderParentDashboard();
      } else if (password !== null) {
        alert('å¯†ç¢¼éŒ¯èª¤ï¼');
      }
    }

    // ========== è§’è‰²å‰µå»º ==========
    let selectedAvatar = null;

    window.selectAvatar = function(element) {
      document.querySelectorAll('.avatar-option').forEach(opt => opt.classList.remove('selected'));
      element.classList.add('selected');
      selectedAvatar = element.dataset.avatar;
    }

    window.createAvatar = async function() {
      try {
        const nameInput = document.getElementById('player-name-input');
        const name = nameInput.value.trim();

        if (!selectedAvatar) {
          alert('è«‹é¸æ“‡ä¸€å€‹è§’è‰²ï¼');
          return;
        }

        if (!name) {
          alert('è«‹è¼¸å…¥ä½ çš„æš±ç¨±ï¼');
          return;
        }

        // å‰µå»ºæ–°ç©å®¶
        const playerId = 'player_' + Date.now();
        gameState.playerId = playerId;
        gameState.playerName = name;
        gameState.avatar = selectedAvatar;
        gameState.quests.daily = generateDailyQuests();
        gameState.quests.main = generateMainQuests();
        gameState.stats.lastLogin = new Date().toDateString();
        gameState.stats.loginStreak = 1;

        localStorage.setItem('jaxon_player_id', playerId);

        await savePlayerData();

        showScreen('kid-main-screen');
        renderWorldMap();
        updateDisplays();
      } catch (error) {
        console.error('å‰µå»ºè§’è‰²å¤±æ•—:', error);
        alert('ç™¼ç”ŸéŒ¯èª¤ï¼Œè«‹é‡è©¦ï¼');
      }
    }

    // ========== è³‡æ–™å­˜å– ==========
    async function savePlayerData() {
      if (!gameState.playerId) return;

      // ç¸½æ˜¯å…ˆå­˜æœ¬åœ°
      try {
        localStorage.setItem('jaxon_game_state', JSON.stringify(gameState));
      } catch (e) {
        console.error('æœ¬åœ°å„²å­˜å¤±æ•—:', e);
      }

      // å¦‚æœæœ‰ Firebase é€£æ¥ï¼Œä¹Ÿå­˜åˆ°é›²ç«¯ï¼ˆè¨­å®š 5 ç§’è¶…æ™‚é¿å…å¡ä½ï¼‰
      if (db) {
        try {
          const dataToSave = { ...gameState };
          dataToSave.updatedAt = new Date().toISOString();
          const timeoutPromise = new Promise((_, reject) =>
            setTimeout(() => reject(new Error('Firebase å¯«å…¥è¶…æ™‚')), 5000)
          );
          await Promise.race([
            db.collection('players').doc(gameState.playerId).set(dataToSave),
            timeoutPromise
          ]);
        } catch (error) {
          console.error('é›²ç«¯å„²å­˜å¤±æ•—:', error);
        }
      }
    }

    async function loadPlayerData() {
      if (!gameState.playerId) return;

      // å…ˆå¾æœ¬åœ°è¼‰å…¥
      try {
        const localData = localStorage.getItem('jaxon_game_state');
        if (localData) {
          Object.assign(gameState, JSON.parse(localData));
        }
      } catch (e) {
        console.error('æœ¬åœ°è³‡æ–™è§£æå¤±æ•—:', e);
      }

      // å¦‚æœæœ‰ Firebase é€£æ¥ï¼Œå˜—è©¦å¾é›²ç«¯è¼‰å…¥ï¼ˆè¨­å®š 5 ç§’è¶…æ™‚é¿å…å¡ä½ï¼‰
      if (db) {
        try {
          const timeoutPromise = new Promise((_, reject) =>
            setTimeout(() => reject(new Error('Firebase è®€å–è¶…æ™‚')), 5000)
          );
          const docSnap = await Promise.race([
            db.collection('players').doc(gameState.playerId).get(),
            timeoutPromise
          ]);
          if (docSnap.exists) {
            const data = docSnap.data();
            Object.assign(gameState, data);
          }
        } catch (error) {
          console.error('é›²ç«¯è¼‰å…¥å¤±æ•—ï¼Œä½¿ç”¨æœ¬åœ°è³‡æ–™:', error);
        }
      }

      // æª¢æŸ¥æ¯æ—¥ä»»å‹™æ˜¯å¦éœ€è¦é‡ç½®
      checkDailyReset();
    }

    function checkDailyReset() {
      const today = new Date().toDateString();
      const lastLogin = gameState.stats.lastLogin;

      if (lastLogin !== today) {
        // é‡ç½®æ¯æ—¥ä»»å‹™
        gameState.quests.daily = generateDailyQuests();
        gameState.energy = gameState.maxEnergy;
        gameState.stats.todayPlayTime = 0;

        // æ›´æ–°é€£çºŒç™»å…¥
        const yesterday = new Date();
        yesterday.setDate(yesterday.getDate() - 1);
        if (lastLogin === yesterday.toDateString()) {
          gameState.stats.loginStreak++;
        } else if (lastLogin !== today) {
          gameState.stats.loginStreak = 1;
        }

        gameState.stats.lastLogin = today;
        savePlayerData();
      }
    }

    // ========== ç•«é¢æ›´æ–° ==========
    function updateDisplays() {
      // æ›´æ–°é ‚éƒ¨æ¬„
      document.getElementById('display-coins').textContent = gameState.coins;
      document.getElementById('display-energy').textContent = gameState.energy;
      document.getElementById('display-level').textContent = `Lv.${gameState.level}`;
      document.getElementById('display-name').textContent = gameState.playerName;

      const expPercent = (gameState.exp / gameState.expToNext) * 100;
      document.getElementById('display-exp-bar').style.width = `${expPercent}%`;

      // æ›´æ–°æ‰€æœ‰é‡‘å¹£é¡¯ç¤º
      document.querySelectorAll('.coins-display').forEach(el => {
        el.textContent = gameState.coins;
      });

      document.querySelectorAll('.energy-display').forEach(el => {
        el.textContent = gameState.energy;
      });
    }

    // ========== ä¸–ç•Œåœ°åœ– ==========
    function renderWorldMap() {
      const container = document.getElementById('worlds-container');
      container.innerHTML = '';

      Object.values(WORLDS).forEach(world => {
        const progress = gameState.worldProgress[world.id];
        const isLocked = !progress.unlocked;
        const progressPercent = (progress.completed / world.levels) * 100;

        const card = document.createElement('div');
        card.className = `world-card ${world.color} ${isLocked ? 'locked' : ''}`;
        card.innerHTML = `
          <div class="world-icon">${world.icon}</div>
          <div class="world-name">${world.name}</div>
          <div class="world-desc">${world.desc}</div>
          <div class="world-progress">
            <div class="world-progress-fill" style="width: ${progressPercent}%"></div>
          </div>
          <div class="world-stars">${'â­'.repeat(Math.min(progress.stars, 5))}${'â˜†'.repeat(Math.max(0, 5 - progress.stars))}</div>
          ${isLocked ? '<div class="lock-icon">ğŸ”’</div>' : ''}
        `;

        if (!isLocked) {
          card.onclick = () => enterWorld(world.id);
        }

        container.appendChild(card);
      });
    }

    window.enterWorld = function(worldId) {
      gameState.currentWorld = worldId;
      document.getElementById('world-map-view').classList.add('hidden');
      document.getElementById('level-select-view').classList.remove('hidden');

      const world = WORLDS[worldId];
      document.getElementById('current-world-title').textContent = `${world.icon} ${world.name}`;

      renderLevelPath(worldId);
    }

    window.backToWorldMap = function() {
      document.getElementById('level-select-view').classList.add('hidden');
      document.getElementById('world-map-view').classList.remove('hidden');
      gameState.currentWorld = null;
    }

    function renderLevelPath(worldId) {
      const container = document.getElementById('level-path');
      container.innerHTML = '';

      const world = WORLDS[worldId];
      const progress = gameState.worldProgress[worldId];

      for (let i = 1; i <= world.levels; i++) {
        const isCompleted = i <= progress.completed;
        const isCurrent = i === progress.completed + 1;
        const isLocked = i > progress.completed + 1;
        const isBoss = i === world.levels;

        const node = document.createElement('div');
        node.className = `level-node ${isCompleted ? 'completed' : ''} ${isCurrent ? 'current' : ''} ${isLocked ? 'locked' : ''} ${isBoss ? 'boss' : ''}`;
        node.innerHTML = isBoss ? 'ğŸ‘‘' : i;

        if (!isLocked) {
          node.onclick = () => startLevel(worldId, i);
        }

        container.appendChild(node);
      }
    }

    // ========== éŠæˆ²é‚è¼¯ ==========
    let gameTimer = null;
    let gameQuestions = [];
    let currentQuestionIndex = 0;
    let gameStartTime = 0;
    let gameCorrect = 0;
    let gameWrong = 0;

    window.startLevel = function(worldId, level) {
      if (gameState.energy < 5) {
        alert('èƒ½é‡ä¸è¶³ï¼ä¼‘æ¯ä¸€ä¸‹å†ä¾†å§ï½');
        return;
      }

      gameState.currentWorld = worldId;
      gameState.currentLevel = level;

      // ç”Ÿæˆé¡Œç›®
      const world = WORLDS[worldId];
      gameQuestions = [];
      const questionCount = 5 + Math.floor(level / 2);

      for (let i = 0; i < questionCount; i++) {
        gameQuestions.push(world.generateQuestion(level));
      }

      currentQuestionIndex = 0;
      gameCorrect = 0;
      gameWrong = 0;
      gameStartTime = Date.now();

      // æ‰£é™¤èƒ½é‡
      gameState.energy -= 5;
      updateDisplays();

      showScreen('game-screen');
      document.getElementById('game-level-display').textContent = level;
      renderGameProgress();
      showQuestion();
      startTimer(60 + level * 10);
    }

    function startTimer(seconds) {
      let timeLeft = seconds;
      const timerEl = document.getElementById('game-timer');

      gameTimer = setInterval(() => {
        timeLeft--;
        timerEl.textContent = timeLeft;

        if (timeLeft <= 10) {
          timerEl.classList.add('warning');
        }

        if (timeLeft <= 0) {
          endGame(false);
        }
      }, 1000);
    }

    function renderGameProgress() {
      const container = document.getElementById('game-progress');
      container.innerHTML = '';

      gameQuestions.forEach((_, i) => {
        const dot = document.createElement('div');
        dot.className = 'progress-dot';
        if (i < currentQuestionIndex) {
          dot.classList.add(i < gameCorrect ? 'correct' : 'wrong');
        } else if (i === currentQuestionIndex) {
          dot.classList.add('current');
        }
        container.appendChild(dot);
      });
    }

    function showQuestion() {
      const q = gameQuestions[currentQuestionIndex];
      document.getElementById('game-question').textContent = q.question;
      document.getElementById('game-input').value = '';
    }

    window.inputNumber = function(num) {
      const input = document.getElementById('game-input');
      if (num === '-' && input.value.length > 0) return;
      if (input.value.length >= 6) return;
      input.value += num;
    }

    window.clearInput = function() {
      const input = document.getElementById('game-input');
      input.value = input.value.slice(0, -1);
    }

    window.submitAnswer = function() {
      const input = document.getElementById('game-input');
      const userAnswer = parseInt(input.value);
      const correctAnswer = gameQuestions[currentQuestionIndex].answer;

      if (isNaN(userAnswer)) return;

      if (userAnswer === correctAnswer) {
        gameCorrect++;
        document.getElementById('game-question').classList.add('bounce');
      } else {
        gameWrong++;
        document.getElementById('game-question').classList.add('shake');
      }

      setTimeout(() => {
        document.getElementById('game-question').classList.remove('bounce', 'shake');
      }, 500);

      currentQuestionIndex++;
      renderGameProgress();

      if (currentQuestionIndex >= gameQuestions.length) {
        endGame(true);
      } else {
        showQuestion();
      }
    }

    function endGame(completed) {
      clearInterval(gameTimer);

      const totalTime = Math.floor((Date.now() - gameStartTime) / 1000);
      const accuracy = Math.round((gameCorrect / gameQuestions.length) * 100);

      // è¨ˆç®—æ˜Ÿæ˜Ÿ
      let stars = 0;
      if (accuracy >= 60) stars = 1;
      if (accuracy >= 80) stars = 2;
      if (accuracy >= 95) stars = 3;

      // è¨ˆç®—çå‹µ
      const baseCoins = 10 * gameState.currentLevel;
      const bonusCoins = stars * 10;
      const totalCoins = baseCoins + bonusCoins;

      const baseExp = 15 * gameState.currentLevel;
      const bonusExp = stars * 5;
      const totalExp = baseExp + bonusExp;

      // æ›´æ–°éŠæˆ²ç‹€æ…‹
      if (completed && accuracy >= 60) {
        const worldProgress = gameState.worldProgress[gameState.currentWorld];
        if (gameState.currentLevel > worldProgress.completed) {
          worldProgress.completed = gameState.currentLevel;
        }
        worldProgress.stars += stars;

        // æª¢æŸ¥è§£é–æ–°ä¸–ç•Œ
        checkWorldUnlocks();
      }

      gameState.coins += totalCoins;
      gameState.exp += totalExp;
      gameState.stats.totalStars += stars;
      gameState.stats.totalLevels++;
      gameState.stats.totalCorrect += gameCorrect;
      gameState.stats.totalQuestions += gameQuestions.length;

      // æª¢æŸ¥å‡ç´š
      while (gameState.exp >= gameState.expToNext) {
        gameState.exp -= gameState.expToNext;
        gameState.level++;
        gameState.expToNext = Math.floor(gameState.expToNext * 1.2);
        gameState.maxEnergy += 10;
      }

      // æ›´æ–°ä»»å‹™é€²åº¦
      updateQuestProgress('levels', 1);
      updateQuestProgress('correct', gameCorrect);
      updateQuestProgress('stars', stars);

      // é¡¯ç¤ºçµæœ
      document.getElementById('result-icon').textContent = accuracy >= 60 ? 'ğŸ‰' : 'ğŸ’ª';
      document.getElementById('result-title').textContent = accuracy >= 60 ? 'å¤ªæ£’äº†ï¼' : 'å†æ¥å†å²ï¼';
      document.getElementById('result-correct').textContent = gameCorrect;
      document.getElementById('result-time').textContent = `${totalTime}ç§’`;
      document.getElementById('result-accuracy').textContent = `${accuracy}%`;
      document.getElementById('result-stars').textContent = 'â­'.repeat(stars) || 'â€”';
      document.getElementById('result-coins').textContent = `+${totalCoins}`;
      document.getElementById('result-exp').textContent = `+${totalExp}`;

      document.getElementById('result-overlay').classList.remove('hidden');

      savePlayerData();
      updateDisplays();
    }

    function checkWorldUnlocks() {
      Object.entries(WORLDS).forEach(([worldId, world]) => {
        if (world.unlockRequirement && !gameState.worldProgress[worldId].unlocked) {
          const req = world.unlockRequirement;
          if (gameState.worldProgress[req.world].completed >= req.level) {
            gameState.worldProgress[worldId].unlocked = true;
          }
        }
      });
    }

    function updateQuestProgress(type, amount) {
      gameState.quests.daily.forEach(quest => {
        if (quest.type === type && quest.current < quest.target) {
          quest.current = Math.min(quest.current + amount, quest.target);

          // å®Œæˆä»»å‹™çå‹µ
          if (quest.current >= quest.target) {
            gameState.coins += quest.reward;
          }
        }
      });
    }

    window.closeResult = function() {
      document.getElementById('result-overlay').classList.add('hidden');
      showScreen('kid-main-screen');
      document.getElementById('level-select-view').classList.add('hidden');
      document.getElementById('world-map-view').classList.remove('hidden');
      renderWorldMap();
      updateDisplays();
    }

    // ========== å°èˆªåˆ‡æ› ==========
    window.switchTab = function(tab) {
      document.querySelectorAll('.nav-item').forEach(item => {
        item.classList.toggle('active', item.dataset.tab === tab);
      });

      if (tab === 'map') {
        showScreen('kid-main-screen');
        document.getElementById('level-select-view').classList.add('hidden');
        document.getElementById('world-map-view').classList.remove('hidden');
        renderWorldMap();
      } else if (tab === 'quest') {
        showScreen('quest-screen');
        renderQuests();
      } else if (tab === 'shop') {
        showScreen('shop-screen');
        renderShop('hair');
      } else if (tab === 'avatar') {
        showScreen('avatar-screen');
        renderAvatarScreen();
      }

      updateDisplays();
    }

    // ========== ä»»å‹™ç•«é¢ ==========
    function renderQuests() {
      const dailyContainer = document.getElementById('daily-quests');
      const mainContainer = document.getElementById('main-quests');

      dailyContainer.innerHTML = '';
      mainContainer.innerHTML = '';

      gameState.quests.daily.forEach(quest => {
        const completed = quest.current >= quest.target;
        const progress = (quest.current / quest.target) * 100;

        const card = document.createElement('div');
        card.className = `quest-card ${completed ? 'completed' : ''}`;
        card.innerHTML = `
          <div class="quest-icon">${quest.icon}</div>
          <div class="quest-info">
            <div class="quest-name">${quest.name}</div>
            <div class="quest-progress-bar">
              <div class="quest-progress-fill" style="width: ${progress}%"></div>
            </div>
            <div style="font-size: 12px; color: var(--light); margin-top: 5px;">${quest.current}/${quest.target}</div>
          </div>
          <div class="quest-reward">
            <span>ğŸª™</span>
            <span>${completed ? 'âœ“' : quest.reward}</span>
          </div>
        `;
        dailyContainer.appendChild(card);
      });

      gameState.quests.main.forEach(quest => {
        const card = document.createElement('div');
        card.className = `quest-card ${quest.completed ? 'completed' : ''}`;
        card.innerHTML = `
          <div class="quest-icon">${quest.icon}</div>
          <div class="quest-info">
            <div class="quest-name">${quest.name}</div>
          </div>
          <div class="quest-reward">
            <span>ğŸª™</span>
            <span>${quest.completed ? 'âœ“' : quest.reward}</span>
          </div>
        `;
        mainContainer.appendChild(card);
      });
    }

    // ========== å•†åº—ç•«é¢ ==========
    let currentShopCategory = 'hair';

    window.switchShopCategory = function(category) {
      currentShopCategory = category;
      document.querySelectorAll('.shop-category').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.category === category);
      });
      renderShop(category);
    }

    function renderShop(category) {
      const container = document.getElementById('shop-items');
      container.innerHTML = '';

      const items = SHOP_ITEMS[category];
      items.forEach(item => {
        const owned = gameState.inventory[category].includes(item.id);
        const equipped = gameState.equipped[category] === item.id;

        const itemEl = document.createElement('div');
        itemEl.className = `shop-item ${owned ? 'owned' : ''} ${equipped ? 'equipped' : ''}`;
        itemEl.innerHTML = `
          <div class="shop-item-icon">${item.icon}</div>
          <div class="shop-item-name">${item.name}</div>
          <div class="shop-item-price ${owned ? 'owned' : ''}">
            ${owned ? (equipped ? 'è£å‚™ä¸­' : 'å·²æ“æœ‰') : `<span>ğŸª™</span><span>${item.price}</span>`}
          </div>
        `;

        itemEl.onclick = () => {
          if (!owned) {
            buyItem(category, item);
          } else {
            equipItem(category, item.id);
          }
        };

        container.appendChild(itemEl);
      });
    }

    function buyItem(category, item) {
      if (gameState.coins < item.price) {
        alert('é‡‘å¹£ä¸è¶³ï¼ç¹¼çºŒé—–é—œè³ºå–æ›´å¤šé‡‘å¹£å§ï¼');
        return;
      }

      if (confirm(`ç¢ºå®šè¦èŠ±è²» ${item.price} é‡‘å¹£è³¼è²·ã€Œ${item.name}ã€å—ï¼Ÿ`)) {
        gameState.coins -= item.price;
        gameState.inventory[category].push(item.id);
        gameState.equipped[category] = item.id;
        savePlayerData();
        updateDisplays();
        renderShop(category);
      }
    }

    function equipItem(category, itemId) {
      gameState.equipped[category] = gameState.equipped[category] === itemId ? null : itemId;
      savePlayerData();
      renderShop(category);
    }

    // ========== è§’è‰²ç•«é¢ ==========
    function renderAvatarScreen() {
      document.getElementById('avatar-display-big').textContent = gameState.avatar;
      document.getElementById('avatar-display-name').textContent = gameState.playerName;
      document.getElementById('avatar-display-level').textContent = `Lv.${gameState.level}`;

      const expPercent = (gameState.exp / gameState.expToNext) * 100;
      document.getElementById('avatar-exp-bar').style.width = `${expPercent}%`;
      document.getElementById('avatar-exp-bar').textContent = `${gameState.exp} / ${gameState.expToNext} EXP`;

      document.getElementById('stat-total-stars').textContent = gameState.stats.totalStars;
      document.getElementById('stat-total-levels').textContent = gameState.stats.totalLevels;

      const accuracy = gameState.stats.totalQuestions > 0
        ? Math.round((gameState.stats.totalCorrect / gameState.stats.totalQuestions) * 100)
        : 0;
      document.getElementById('stat-accuracy').textContent = `${accuracy}%`;
      document.getElementById('stat-streak').textContent = gameState.stats.loginStreak;

      // æ›´æ–°è£å‚™é¡¯ç¤º
      Object.entries(gameState.equipped).forEach(([slot, itemId]) => {
        const slotEl = document.getElementById(`equip-${slot}`);
        if (itemId) {
          const item = SHOP_ITEMS[slot].find(i => i.id === itemId);
          if (item) {
            slotEl.querySelector('.equipment-slot-icon').textContent = item.icon;
          }
        }
      });
    }

    // ========== å®¶é•·ç«¯ ==========
    function renderParentDashboard() {
      document.getElementById('parent-total-time').textContent = gameState.stats.todayPlayTime;
      document.getElementById('parent-total-levels').textContent = gameState.stats.totalLevels;

      const accuracy = gameState.stats.totalQuestions > 0
        ? Math.round((gameState.stats.totalCorrect / gameState.stats.totalQuestions) * 100)
        : 0;
      document.getElementById('parent-accuracy').textContent = `${accuracy}%`;
      document.getElementById('parent-streak').textContent = gameState.stats.loginStreak;

      // é€±å­¸ç¿’åœ–è¡¨
      const chartContainer = document.getElementById('weekly-chart');
      chartContainer.innerHTML = '';
      const days = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];
      const maxTime = Math.max(...gameState.stats.weeklyPlayTime, 1);

      gameState.stats.weeklyPlayTime.forEach((time, i) => {
        const bar = document.createElement('div');
        bar.className = 'chart-bar';
        bar.style.height = `${(time / maxTime) * 100}%`;
        bar.innerHTML = `<span class="chart-bar-label">${days[i]}</span>`;
        chartContainer.appendChild(bar);
      });

      // æŠ€èƒ½æŒæ¡åº¦
      const masteryContainer = document.getElementById('mastery-list');
      masteryContainer.innerHTML = '';

      Object.entries(WORLDS).forEach(([worldId, world]) => {
        const progress = gameState.worldProgress[worldId];
        const mastery = Math.round((progress.completed / world.levels) * 100);
        const masteryClass = mastery < 40 ? 'low' : mastery < 70 ? 'medium' : 'high';

        const item = document.createElement('div');
        item.className = 'mastery-item';
        item.innerHTML = `
          <div class="mastery-icon">${world.icon}</div>
          <div class="mastery-info">
            <div class="mastery-name">${world.name}</div>
            <div class="mastery-bar">
              <div class="mastery-fill ${masteryClass}" style="width: ${mastery}%"></div>
            </div>
          </div>
          <div class="mastery-percent">${mastery}%</div>
        `;
        masteryContainer.appendChild(item);
      });

      // è¨­å®š
      document.getElementById('time-limit').value = gameState.parentSettings.timeLimit;
      document.getElementById('level-limit').value = gameState.parentSettings.levelLimit;
      document.getElementById('social-toggle').classList.toggle('active', gameState.parentSettings.socialEnabled);
      document.getElementById('leaderboard-toggle').classList.toggle('active', gameState.parentSettings.leaderboardEnabled);
    }

    window.toggleSetting = function(setting) {
      const toggle = document.getElementById(`${setting}-toggle`);
      toggle.classList.toggle('active');
    }

    window.saveParentSettings = function() {
      gameState.parentSettings = {
        timeLimit: parseInt(document.getElementById('time-limit').value) || 60,
        levelLimit: parseInt(document.getElementById('level-limit').value) || 20,
        socialEnabled: document.getElementById('social-toggle').classList.contains('active'),
        leaderboardEnabled: document.getElementById('leaderboard-toggle').classList.contains('active')
      };
      savePlayerData();
      alert('è¨­å®šå·²å„²å­˜ï¼');
    }

    window.parentLogout = function() {
      showScreen('login-screen');
    }

    // ========== åˆå§‹åŒ– ==========
    window.addEventListener('DOMContentLoaded', () => {
      // æª¢æŸ¥æ˜¯å¦å·²æœ‰ç©å®¶è³‡æ–™
      if (gameState.playerId) {
        loadPlayerData();
      }
    });

    // ========== éµç›¤å°èˆªç³»çµ± ==========
    const kbNav = {
      focusIndex: 0,
      items: [],

      getActiveScreen() {
        return document.querySelector('.screen.active');
      },

      // å–å¾—ç›®å‰ç•«é¢ä¸Šæ‰€æœ‰å¯äº’å‹•çš„å…ƒç´ 
      getNavigableItems() {
        const screen = this.getActiveScreen();
        if (!screen) return [];

        // çµæœå½ˆçª—å„ªå…ˆ
        const overlay = document.getElementById('result-overlay');
        if (!overlay.classList.contains('hidden')) {
          return Array.from(overlay.querySelectorAll('button'));
        }

        const items = [];
        const screenId = screen.id;

        if (screenId === 'login-screen') {
          items.push(...screen.querySelectorAll('.login-btn'));
        } else if (screenId === 'create-avatar-screen') {
          items.push(...screen.querySelectorAll('.avatar-option'));
          items.push(screen.querySelector('#player-name-input'));
          items.push(screen.querySelector('.btn-accent'));
        } else if (screenId === 'kid-main-screen') {
          const levelView = document.getElementById('level-select-view');
          if (!levelView.classList.contains('hidden')) {
            const backBtn = levelView.querySelector('.back-btn');
            if (backBtn) items.push(backBtn);
            items.push(...levelView.querySelectorAll('.level-node:not(.locked)'));
          } else {
            items.push(...screen.querySelectorAll('.world-card:not(.locked)'));
          }
          items.push(...screen.querySelectorAll('.bottom-nav .nav-item'));
        } else if (screenId === 'game-screen') {
          // éŠæˆ²ç•«é¢ç”¨æ•¸å­—éµï¼Œä¸éœ€è¦æ–¹å‘éµå°èˆª
          return [];
        } else if (screenId === 'quest-screen') {
          items.push(...screen.querySelectorAll('.bottom-nav .nav-item'));
        } else if (screenId === 'shop-screen') {
          items.push(...screen.querySelectorAll('.shop-category'));
          items.push(...screen.querySelectorAll('.shop-item'));
          items.push(...screen.querySelectorAll('.bottom-nav .nav-item'));
        } else if (screenId === 'avatar-screen') {
          items.push(...screen.querySelectorAll('.bottom-nav .nav-item'));
        } else if (screenId === 'parent-screen') {
          items.push(screen.querySelector('#time-limit'));
          items.push(screen.querySelector('#level-limit'));
          items.push(screen.querySelector('#social-toggle'));
          items.push(screen.querySelector('#leaderboard-toggle'));
          items.push(...screen.querySelectorAll('.btn'));
        }

        return items.filter(Boolean);
      },

      refresh() {
        this.clearFocus();
        this.items = this.getNavigableItems();
        this.focusIndex = 0;
        if (this.items.length > 0) {
          this.applyFocus();
        }
      },

      clearFocus() {
        document.querySelectorAll('.kb-focus').forEach(el => el.classList.remove('kb-focus'));
      },

      applyFocus() {
        this.clearFocus();
        if (this.items.length === 0) return;
        if (this.focusIndex < 0) this.focusIndex = this.items.length - 1;
        if (this.focusIndex >= this.items.length) this.focusIndex = 0;
        const el = this.items[this.focusIndex];
        if (el) {
          el.classList.add('kb-focus');
          el.scrollIntoView({ block: 'nearest', behavior: 'smooth' });
        }
      },

      move(direction) {
        if (this.items.length === 0) {
          this.items = this.getNavigableItems();
          this.focusIndex = 0;
        }
        if (this.items.length === 0) return;

        const screen = this.getActiveScreen();
        const screenId = screen ? screen.id : '';

        // åˆ¤æ–·ä½¿ç”¨çš„åˆ—æ•¸ï¼ˆgrid layout æƒ…æ³ï¼‰
        let cols = 1;
        if (screenId === 'create-avatar-screen') {
          // è§’è‰²é¸æ“‡ 3x2 gridï¼Œä¹‹å¾Œæ˜¯ input + button
          const avatarCount = screen.querySelectorAll('.avatar-option').length;
          if (this.focusIndex < avatarCount) cols = 3;
        } else if (screenId === 'kid-main-screen') {
          const levelView = document.getElementById('level-select-view');
          if (levelView.classList.contains('hidden')) {
            cols = 1; // world cards æ˜¯ç›´æ’
          } else {
            cols = 5; // level nodes
          }
        } else if (screenId === 'shop-screen') {
          const catCount = screen.querySelectorAll('.shop-category').length;
          const itemCount = screen.querySelectorAll('.shop-item').length;
          if (this.focusIndex < catCount) {
            cols = catCount;
          } else if (this.focusIndex < catCount + itemCount) {
            cols = 2;
          } else {
            cols = 4; // nav items
          }
        }

        if (direction === 'up') {
          this.focusIndex = Math.max(0, this.focusIndex - cols);
        } else if (direction === 'down') {
          this.focusIndex = Math.min(this.items.length - 1, this.focusIndex + cols);
        } else if (direction === 'left') {
          this.focusIndex = Math.max(0, this.focusIndex - 1);
        } else if (direction === 'right') {
          this.focusIndex = Math.min(this.items.length - 1, this.focusIndex + 1);
        }

        this.applyFocus();
      },

      activate() {
        if (this.items.length === 0) return;
        const el = this.items[this.focusIndex];
        if (!el) return;

        if (el.tagName === 'INPUT') {
          el.focus();
          return;
        }

        el.click();
        // ç•«é¢åˆ‡æ›å¾Œé‡æ–°æ•´ç†å°èˆª
        setTimeout(() => this.refresh(), 100);
      }
    };

    document.addEventListener('keydown', (e) => {
      // éŠæˆ²ç•«é¢ç¶­æŒåŸæœ‰çš„æ•¸å­—éµè¼¸å…¥
      if (document.getElementById('game-screen').classList.contains('active')) {
        if (e.key >= '0' && e.key <= '9') {
          inputNumber(e.key);
        } else if (e.key === '-') {
          inputNumber('-');
        } else if (e.key === 'Backspace') {
          clearInput();
        } else if (e.key === 'Enter') {
          submitAnswer();
        }
        return;
      }

      // å¦‚æœæ­£åœ¨ input è¼¸å…¥ä¸­ï¼Œåªæ””æˆª Enter
      if (document.activeElement && document.activeElement.tagName === 'INPUT') {
        if (e.key === 'Enter') {
          e.preventDefault();
          document.activeElement.blur();
          kbNav.move('down');
        }
        return;
      }

      switch (e.key) {
        case 'ArrowUp':
          e.preventDefault();
          kbNav.move('up');
          break;
        case 'ArrowDown':
          e.preventDefault();
          kbNav.move('down');
          break;
        case 'ArrowLeft':
          e.preventDefault();
          kbNav.move('left');
          break;
        case 'ArrowRight':
          e.preventDefault();
          kbNav.move('right');
          break;
        case 'Enter':
          e.preventDefault();
          kbNav.activate();
          break;
      }
    });

    // ç•«é¢åˆ‡æ›æ™‚è‡ªå‹•é‡æ–°æ•´ç†éµç›¤å°èˆª
    const origShowScreen = window.showScreen;
    window.showScreen = function(screenId) {
      origShowScreen(screenId);
      setTimeout(() => kbNav.refresh(), 150);
    };
  </script>
</body>
</html>
